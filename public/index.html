<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  
  <!-- SEO:BEGIN -->
  <meta name="description" content="LOOKLI הוא מנוע חיפוש חכם לאופנה צנועה שמרכז אלפי מוצרים מעשרות חנויות. חיפוש חופשי, סינונים חכמים והשוואה במקום אחד."/>
  <link rel="canonical" href="https://lookli.co.il/"/>
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1"/>
  <meta name="theme-color" content="#c48cb3"/>

  <!-- Open Graph -->
  <meta property="og:locale" content="he_IL"/>
  <meta property="og:type" content="website"/>
  <meta property="og:site_name" content="LOOKLI"/>
  <meta property="og:title" content="LOOKLI – מנוע חיפוש חכם לאופנה צנועה | אלפי מוצרים במקום אחד"/>
  <meta property="og:description" content="LOOKLI הוא מנוע חיפוש חכם לאופנה צנועה שמרכז אלפי מוצרים מעשרות חנויות. חיפוש חופשי, סינונים חכמים והשוואה במקום אחד."/>
  <meta property="og:url" content="https://lookli.co.il/"/>
  <meta property="og:image" content="https://lookli.co.il/lookli-logo.png"/>

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="LOOKLI – מנוע חיפוש חכם לאופנה צנועה | אלפי מוצרים במקום אחד"/>
  <meta name="twitter:description" content="LOOKLI הוא מנוע חיפוש חכם לאופנה צנועה שמרכז אלפי מוצרים מעשרות חנויות. חיפוש חופשי, סינונים חכמים והשוואה במקום אחד."/>
  <meta name="twitter:image" content="https://lookli.co.il/lookli-logo.png"/>

    <link rel="preconnect" href="https://mekimi.co.il"/>
  <link rel="preconnect" href="https://lichi-shop.com"/>
  <link rel="preconnect" href="https://static.wixstatic.com"/>
  <link rel="preconnect" href="https://aviyahyosef.com"/>
  <link rel="preconnect" href="https://chemise.co.il"/>
  <link rel="dns-prefetch" href="https://mekimi.co.il"/>
  <link rel="dns-prefetch" href="https://lichi-shop.com"/>
  <meta name="keywords" content="אופנה צנועה, בגדים צנועים, שמלות צנועות, חצאיות ארוכות, חולצות צנועות, אופנה דתית, חיפוש בגדים, השוואת מחירים, LOOKLI, מקסי, לופטה, מקימי, ליצ'י, אביה יוסף"/>
  <link rel="icon" href="/favicon.ico"/>
  <link rel="alternate" hreflang="he-il" href="https://lookli.co.il/"/>

  <script type="application/ld+json">{"@context": "https://schema.org", "@graph": [{"@context": "https://schema.org", "@type": "Organization", "name": "LOOKLI", "url": "https://lookli.co.il", "logo": "https://lookli.co.il/lookli-logo.png", "contactPoint": [{"@type": "ContactPoint", "contactType": "customer support", "email": "info@lookli.co.il", "availableLanguage": ["he", "en"]}]}, {"@context": "https://schema.org", "@type": "WebSite", "name": "LOOKLI", "url": "https://lookli.co.il", "potentialAction": {"@type": "SearchAction", "target": "https://lookli.co.il/?q={search_term_string}", "query-input": "required name=search_term_string"}}, {"@type": "WebPage", "url": "https://lookli.co.il/", "name": "LOOKLI – מנוע חיפוש חכם לאופנה צנועה | אלפי מוצרים במקום אחד", "inLanguage": "he-IL", "dateModified": "2026-02-22"}]}</script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": "מנוע חיפוש אופנה צנועה - LOOKLI",
    "description": "אלפי מוצרי אופנה צנועה ממותגים מובילים: מקימי, ליצ'י, מימה, אביה יוסף, שמיז",
    "url": "https://lookli.co.il/",
    "numberOfItems": "5000+",
    "itemListElement": [
      {"@type":"ListItem","position":1,"name":"שמלות צנועות","url":"https://lookli.co.il/?q=שמלה"},
      {"@type":"ListItem","position":2,"name":"חצאיות מקסי","url":"https://lookli.co.il/?q=חצאית+מקסי"},
      {"@type":"ListItem","position":3,"name":"חולצות צנועות","url":"https://lookli.co.il/?q=חולצה"},
      {"@type":"ListItem","position":4,"name":"חליפות","url":"https://lookli.co.il/?q=חליפה"},
      {"@type":"ListItem","position":5,"name":"קרדיגנים","url":"https://lookli.co.il/?q=קרדיגן"}
    ]
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "מה זה LOOKLI?",
        "acceptedAnswer": {"@type":"Answer","text":"LOOKLI הוא מנוע חיפוש חכם לאופנה צנועה המרכז מוצרים מחנויות מובילות כמו מקימי, ליצ'י, מימה, אביה יוסף ושמיז — במקום אחד."}
      },
      {
        "@type": "Question",
        "name": "האם ניתן לחפש לפי מידה וצבע?",
        "acceptedAnswer": {"@type":"Answer","text":"כן! ניתן לסנן לפי מידה, צבע, קטגוריה, מחיר, חנות ועוד פילטרים חכמים."}
      },
      {
        "@type": "Question",
        "name": "האם המחירים באתר מעודכנים?",
        "acceptedAnswer": {"@type":"Answer","text":"המחירים מתעדכנים אוטומטית ממגוון חנויות האופנה. הקנייה מתבצעת ישירות באתר החנות."}
      }
    ]
  }
  </script>
<!-- SEO:END -->
<title>LOOKLI – מנוע חיפוש חכם לאופנה צנועה | אלפי מוצרים במקום אחד</title>
  <style>
    :root{
      --bg:#fff;
      --card:#fff;
      --text:#787878;
      --muted:#787878;
      --accent:#e0a1c0;
      --accent-light:#787878;
      --accent-dark:#e0a1c0;
      --border:#fff;
      --radius:4px;
      --shadow:0 4px 20px rgba(0,0,0,.08);
      --shadow2:0 8px 40px rgba(0,0,0,.12);
      --container:1600px;
      --sidebar:280px;
      --header-gradient:linear-gradient(135deg,#d191b0 50%,#c48cb3 100%);
      --sale-color:#ef4444
    }
    *{box-sizing:border-box;font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    
    /* ===== HEADER ===== */
    .header{background:var(--header-gradient);padding:0;position:sticky;top:0;z-index:100;box-shadow:0 4px 30px rgba(102,126,234,.3)}
    .header-top{max-width:var(--container);margin:0 auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:14px;text-decoration:none}
    .logo img{height:48px;width:auto}
    .header-nav{display:flex;gap:20px}
    .header-nav a{color:#fff;font-weight:600;font-size:14px;text-decoration:none;padding:8px 16px;border-radius:8px;transition:background .2s}
    .header-nav a:hover{background:rgba(255,255,255,.2)}
    
    /* Active Filters Bar */
    .active-filters-bar{display:none;background:#fff;border-bottom:1px solid var(--border);padding:10px 24px}
    .active-filters-bar.show{display:block}
    .active-filters-inner{max-width:var(--container);margin:0 auto;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .active-filters-label{font-weight:700;font-size:13px;color:var(--muted)}
    .active-filters-tags{display:flex;gap:8px;flex-wrap:wrap}
    .filter-tag{display:flex;align-items:center;gap:6px;background:var(--accent);color:#fff;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600}
    .filter-tag .remove-tag{cursor:pointer;font-size:14px;opacity:.8}
    .filter-tag .remove-tag:hover{opacity:1}
    .clear-all-btn{background:none;border:2px solid var(--border);padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .15s}
    .clear-all-btn:hover{border-color:var(--accent);color:var(--accent)}
    
    /* Search Bar */
    .search-section{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.1)}
    .search-inner{max-width:var(--container);margin:0 auto;padding:12px 24px}
    .searchbar{display:flex;gap:12px;background:#fff;border-radius:14px;padding:6px;box-shadow:var(--shadow2)}
    .searchbar input{flex:1;border:0;outline:none;font-size:16px;padding:12px 18px;background:transparent;font-weight:500}
    .searchbar input::placeholder{color:#9ca3af}
    .searchbar .btn{border:none;cursor:pointer;padding:14px 20px;border-radius:10px;background:var(--accent);transition:all .2s;display:flex;align-items:center;justify-content:center}
    .searchbar .btn:hover{background:var(--accent-dark);transform:translateY(-2px)}
    .searchbar .btn svg{width:24px;height:24px;color:#fff}
    
    /* AI Analysis removed */
    
    /* ===== MAIN LAYOUT ===== */
    .wrap{display:flex;gap:0;min-height:calc(100vh - 140px)}
    @media(max-width:1000px){.wrap{flex-direction:column}.filters{display:none}}
    
    /* ===== SIDEBAR ===== */
    .filters{width:var(--sidebar);background:#fff;border-left:1px solid var(--border);padding:0;flex-shrink:0;overflow-y:auto;height:calc(100vh - 136px);position:sticky;top:136px}
    .filters::-webkit-scrollbar{width:5px}
    .filters::-webkit-scrollbar-track{background:#f3f4f6}
    .filters::-webkit-scrollbar-thumb{background:var(--accent-light);border-radius:3px}
    
    /* Filter Accordion */
    .filter-section{border-bottom:1px solid var(--border)}
    .filter-header{display:flex;justify-content:space-between;align-items:center;padding:18px 20px;cursor:pointer;font-weight:700;font-size:15px;color:var(--text);transition:background .15s}
    .filter-header:hover{background:#f9fafb}
    .filter-header .arrow{transition:transform .2s;color:var(--muted);font-size:12px}
    .filter-section.open .filter-header .arrow{transform:rotate(180deg)}
    .filter-content{display:none;padding:0 20px 18px}
    .filter-section.open .filter-content{display:block}
    
    /* Filter Options */
    .filter-options{display:flex;flex-wrap:wrap;gap:8px}
    .filter-opt{padding:10px 16px;border:2px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-weight:700;font-size:14px;transition:all .15s;color:var(--muted)}
    .filter-opt:hover{border-color:var(--accent-light);color:var(--accent)}
    .filter-opt.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    
    /* Store logos */
    .store-opts{display:flex;gap:8px;flex-wrap:wrap;max-height:140px;overflow-y:auto}
    .store-opt{width:50px;height:50px;border:2px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;overflow:hidden;flex-shrink:0}
    .store-opt:hover{border-color:var(--accent-light)}
    .store-opt.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(144,97,249,.2)}
    .store-opt img{width:100%;height:100%;object-fit:contain;padding:4px}
    .store-opt span{font-size:12px;font-weight:800}
    
    /* Color options */
    .color-opts{display:flex;flex-wrap:wrap;gap:10px}
    .color-opt{width:34px;height:34px;border-radius:50%;border:3px solid #ddd;cursor:pointer;transition:all .15s;box-shadow:0 2px 4px rgba(0,0,0,.15)}
    .color-opt:hover{transform:scale(1.1)}
    .color-opt.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(144,97,249,.3)}
    
    /* Size options */
    .size-opts{display:flex;flex-wrap:wrap;gap:8px}
    .size-opt{min-width:48px;padding:10px 14px;border:2px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-weight:700;font-size:14px;text-align:center;transition:all .15s}
    .size-opt:hover{border-color:var(--accent-light)}
    .size-opt.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    
    /* Price slider */
    .price-section{padding:10px 0}
    .price-display{font-size:16px;font-weight:800;color:var(--accent);text-align:center;margin-bottom:12px}
    .price-slider input[type="range"]{width:100%;height:6px;border-radius:3px;background:linear-gradient(to left,var(--accent),var(--accent-light));outline:none;-webkit-appearance:none;cursor:pointer}
    .price-slider input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:#fff;border:3px solid var(--accent);cursor:pointer;box-shadow:0 2px 6px rgba(144,97,249,.3)}
    
    /* Reset button */
    .reset-btn{width:100%;padding:14px;margin-top:10px;border:2px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;font-weight:700;font-size:14px;color:var(--muted);transition:all .15s}
    .reset-btn:hover{border-color:var(--accent);color:var(--accent)}
    
    /* Design filter - compact */
    #designBoxes .filter-opt{padding:7px 12px;font-size:12px}
    
    /* ===== MOBILE STYLES ===== */
    @media(max-width:768px){
      .header-top{padding:10px 16px}
      .logo img{height:36px}
      .header-nav{display:none}
      .search-inner{padding:10px 16px}
      .searchbar{padding:4px;border-radius:10px}
      .searchbar input{font-size:14px;padding:10px 12px}
      .searchbar .btn{padding:10px 14px;border-radius:8px}
      .searchbar .btn svg{width:20px;height:20px}
      
      .active-filters-bar{padding:8px 16px}
      .active-filters-inner{gap:8px}
      .active-filters-label{font-size:12px}
      .filter-tag{padding:5px 10px;font-size:11px}
      
      .wrap{flex-direction:column}
      .filters{display:none;position:fixed;top:0;right:0;width:85%;max-width:320px;height:100vh;z-index:200;background:#fff;transform:translateX(100%);transition:transform .3s ease}
      .filters.open{display:block;transform:translateX(0)}
      
      /* Mobile Sidebar Design */
      .filter-section{border-bottom:1px solid #eee}
      .filter-header{padding:16px 20px;font-size:14px}
      .filter-content{padding:0 16px 16px}
      .filter-opt{padding:8px 14px;font-size:13px;border-radius:6px}
      .color-opt{width:30px;height:30px}
      .size-opt{min-width:42px;padding:8px 12px;font-size:12px}
      .store-opt{width:42px;height:42px;border-radius:8px}
      
      .mobile-filter-btn{display:flex !important;position:fixed;bottom:80px;right:16px;width:50px;height:50px;background:var(--accent);border-radius:50%;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(224,161,192,.4);z-index:149;color:#fff;font-size:20px;border:none;cursor:pointer}
      
      .mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:199}
      .mobile-overlay.show{display:block}
      
      .main{padding:16px}
      .toolbar{margin-bottom:12px}
      .meta{font-size:13px}
      
      .grid{grid-template-columns:repeat(2,1fr);gap:10px}
      .card{border-radius:4px}
      .card-body{padding:10px}
      .title{font-size:12px;min-height:32px}
      .price{font-size:14px}
      .price-original{font-size:11px}
      .store{font-size:10px}
      .card-footer{margin-top:6px}
      .sizes{font-size:9px}
      .shipping-badge{font-size:8px;padding:3px 6px}
      .sale-badge{font-size:9px;padding:4px 8px;top:6px;left:6px;border-radius:2px}
      .card-logo{width:32px;height:32px;top:6px;right:6px;border-radius:4px}
      .card-colors{padding:3px 5px;bottom:6px;right:6px;border-radius:4px}
      .card-color{width:12px;height:12px}
      .img-wrap{border-radius:4px 4px 0 0}
      
      .ads-sidebar{display:none !important}
      
      .whatsapp-btn{bottom:16px;right:16px;width:50px;height:50px}
      .whatsapp-btn svg{width:24px;height:24px}
      
      .modal{width:100%;max-height:100vh;border-radius:0}
      .modal-body{grid-template-columns:1fr;padding:12px 16px}
      .modal-head{padding:14px 16px}
      .modal-title{font-size:15px}
    }
    
    @media(max-width:400px){
      .grid{gap:8px}
      .card-body{padding:8px}
      .title{font-size:11px}
      .price{font-size:13px}
    }
    
    .mobile-filter-btn{display:none}
    
    /* Mobile Menu Button */
    .mobile-menu-btn{display:none;background:none;border:none;color:#fff;font-size:28px;cursor:pointer;padding:8px}
    @media(max-width:768px){
      .mobile-menu-btn{display:block}
    }
    
    /* Filter close button */
    .filter-close-btn{display:none;position:absolute;top:12px;left:12px;width:36px;height:36px;background:#fff;border:1px solid #eee;border-radius:50%;font-size:18px;cursor:pointer;z-index:10}
    @media(max-width:768px){
      .filter-close-btn{display:flex;align-items:center;justify-content:center}
      .filters{position:relative}
    }
    .main{flex:1;padding:20px 24px;min-height:60vh}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .meta{color:var(--muted);font-size:14px;font-weight:700}
    
    /* Ads area */
    .ads-sidebar{width:180px;flex-shrink:0;padding:20px 12px;display:none}
    @media(min-width:1300px){.ads-sidebar{display:block}}
    .ad-placeholder{background:#f0f0f0;border:2px dashed #ccc;border-radius:12px;height:600px;display:flex;align-items:center;justify-content:center;color:#999;font-size:13px;text-align:center}
    
    /* Product Grid - 4 columns */
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
    @media(max-width:1200px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:500px){.grid{grid-template-columns:1fr}}
    
    /* Product Card */
    .card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);cursor:pointer;transition:transform .2s,box-shadow .2s}
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow2)}
    .img-wrap{position:relative;width:100%;aspect-ratio:3/4;background:#f3f4f6;overflow:hidden}
    
    /* SALE Badge */
    .sale-badge{position:absolute;top:10px;left:10px;background:var(--sale-color);color:#fff;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:800;z-index:5;box-shadow:0 3px 10px rgba(239,68,68,.3)}
    
    /* Carousel */
    .carousel{position:relative;width:100%;height:100%}
    .carousel-inner{display:flex;height:100%;transition:transform .3s ease}
    .carousel-slide{min-width:100%;height:100%}
    .carousel-slide img{width:100%;height:100%;object-fit:cover}
    .carousel-dots{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:5px}
    .carousel-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.5);cursor:pointer;border:1px solid rgba(0,0,0,.2)}
    .carousel-dot.active{background:#fff}
    .carousel-nav{position:absolute;top:50%;transform:translateY(-50%);width:28px;height:28px;background:rgba(255,255,255,.9);border:none;border-radius:50%;cursor:pointer;font-size:14px;font-weight:bold;display:none;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.15);color:#333}
    .img-wrap:hover .carousel-nav{display:flex}
    .carousel-prev{right:8px}
    .carousel-next{left:8px}
    
    /* Card elements */
    .card-logo{position:absolute;top:10px;right:10px;width:42px;height:42px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.9);border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .card-logo img{max-width:90%;max-height:90%;object-fit:contain}
    .card-colors{position:absolute;bottom:10px;right:10px;display:flex;gap:4px;background:rgba(255,255,255,.95);padding:5px 8px;border-radius:16px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .card-color{width:16px;height:16px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .card-color-more{font-size:10px;font-weight:800;color:#666;padding:0 3px;display:flex;align-items:center}
    
    .card-body{padding:14px}
    .title{font-size:14px;font-weight:700;line-height:1.4;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;min-height:40px;color:var(--text)}
    .subrow{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .price-wrap{display:flex;align-items:center;gap:6px}
    .price{font-weight:900;font-size:17px}
    .price-original{font-size:13px;color:var(--muted);text-decoration:line-through}
    .price.sale{color:var(--sale-color)}
    .store{font-size:12px;color:var(--muted);font-weight:600}
    .card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:6px}
    .sizes{font-size:11px;color:var(--muted);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .shipping-badge{font-size:10px;font-weight:700;padding:4px 8px;border-radius:5px;white-space:nowrap;color:var(--accent);background:rgba(144,97,249,.1)}
    .shipping-badge.free{color:#16a34a;background:#dcfce7}
    
    .empty{padding:50px;text-align:center;color:var(--muted);border:2px dashed var(--border);border-radius:var(--radius);background:#fff;font-weight:700;font-size:15px}
    
    /* ===== MODAL ===== */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:200;padding:20px;overflow-y:auto;backdrop-filter:blur(4px)}
    .modal-backdrop.open{display:flex;align-items:flex-start;justify-content:center;padding-top:20px;padding-bottom:20px}
    .modal{width:min(1000px,100%);max-height:calc(100vh - 40px);background:#fff;border-radius:18px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,.25)}
    .modal-head{padding:18px 22px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);flex-shrink:0}
    .modal-title{font-weight:800;font-size:17px;max-width:85%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .close-btn{width:40px;height:40px;border-radius:10px;border:2px solid var(--border);background:#fff;cursor:pointer;font-size:18px;transition:all .15s}
    .close-btn:hover{border-color:var(--accent);color:var(--accent)}
    .modal-body{display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:18px 22px;overflow-y:auto;flex:1;min-height:0}
    @media(max-width:800px){.modal-body{grid-template-columns:1fr;overflow-y:auto}}
    
    /* Modal Gallery */
    .gallery{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#f9f9f9}
    .gallery-carousel{position:relative;width:100%;overflow:hidden;background:#f3f4f6}
    .gallery-carousel-inner{display:flex;transition:transform .3s ease}
    .gallery-carousel-slide{min-width:100%;display:flex;align-items:center;justify-content:center}
    .gallery-carousel-slide img{width:100%;height:auto;object-fit:contain;max-height:75vh}
    .gallery-nav{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;background:rgba(255,255,255,.95);border:none;border-radius:50%;cursor:pointer;font-size:18px;font-weight:bold;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,.15);color:#333}
    .gallery-prev{right:12px}
    .gallery-next{left:12px}
    .gallery-dots{display:flex;gap:6px;justify-content:center;padding:12px}
    .gallery-dot{width:9px;height:9px;border-radius:50%;background:#ddd;cursor:pointer;border:none;transition:background .15s}
    .gallery-dot.active{background:var(--accent)}
    .gallery-thumbs{display:flex;gap:8px;padding:10px;overflow-x:auto}
    .gallery-thumb{width:55px;height:70px;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid transparent;flex-shrink:0;background:#f3f4f6;transition:border-color .15s}
    .gallery-thumb.active{border-color:var(--accent)}
    .gallery-thumb img{width:100%;height:100%;object-fit:cover}
    
    .details{border:1px solid var(--border);border-radius:14px;padding:18px;display:flex;flex-direction:column;gap:14px}
    .kpi{display:flex;gap:8px;flex-wrap:wrap}
    .kpi span{border:2px solid var(--border);padding:9px 14px;border-radius:8px;font-weight:700;font-size:13px;color:var(--muted)}
    .kpi span.sale-kpi{border-color:var(--sale-color);color:var(--sale-color);background:rgba(239,68,68,.05)}
    .kpi span.shipping-kpi{border-color:var(--accent-light);color:var(--accent)}
    .kpi span.shipping-kpi.free{border-color:#16a34a;color:#16a34a;background:#dcfce7}
    .modal-colors-section{margin-top:4px}
    .modal-colors{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .modal-color{width:36px;height:36px;border-radius:50%;border:3px solid #ddd;cursor:pointer;transition:transform .15s;box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .modal-color:hover{transform:scale(1.1)}
    .desc{color:#555;font-size:13px;line-height:1.7;white-space:pre-line}
    .desc-title{font-weight:700;font-size:14px;margin-bottom:8px;color:var(--text)}
    .label{font-size:12px;color:var(--muted);margin-bottom:8px;font-weight:700;text-transform:uppercase}
    .buy-big{margin-top:auto}
    .buy-big a{display:block;text-align:center;padding:14px;border-radius:12px;font-weight:800;background:var(--accent);color:#fff;font-size:15px;transition:all .2s}
    .buy-big a:hover{background:var(--accent-dark)}
    
    /* Footer */
    footer{background:#3a3a3a;color:#fff;margin-top:40px}
    .footer-inner{max-width:var(--container);margin:0 auto;padding:40px 24px;display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:40px}
    @media(max-width:900px){.footer-inner{grid-template-columns:1fr 1fr;gap:30px}}
    @media(max-width:500px){.footer-inner{grid-template-columns:1fr}}
    .footer-section h4{font-size:14px;font-weight:700;margin:0 0 16px;color:var(--accent-light)}
    .footer-section a{display:block;color:rgba(255,255,255,.7);font-size:13px;text-decoration:none;margin-bottom:10px;transition:color .15s}
    .footer-section a:hover{color:#fff}
    .footer-brand{font-weight:900;font-size:24px;margin-bottom:12px}
    .footer-desc{font-size:13px;color:rgba(255,255,255,.6);line-height:1.6;margin:0}
    .footer-bottom{border-top:1px solid rgba(255,255,255,.1);text-align:center;padding:20px 24px;font-size:12px;color:rgba(255,255,255,.5)}
    
    /* WhatsApp Button */
    .whatsapp-btn{position:fixed;bottom:24px;right:24px;width:56px;height:56px;background:#c48cb3;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(196,140,179,.4);z-index:150;transition:transform .2s,box-shadow .2s}
    .whatsapp-btn:hover{transform:scale(1.1);box-shadow:0 6px 30px rgba(196,140,179,.5)}
    .whatsapp-btn svg{width:28px;height:28px;color:#fff}
    
    /* Load more button */
    #loadMoreBtn{margin:24px auto;display:block;max-width:220px;padding:14px 28px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer;transition:background .2s}
    #loadMoreBtn:hover{background:var(--accent-dark)}
    
    /* Multi-select link */
    
    /* Multi-select modal */
    .ms-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:300;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(3px)}
    .ms-modal-bg.open{display:flex}
    .ms-modal{background:#fff;border-radius:18px;width:min(500px,95%);max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25);display:flex;flex-direction:column}
    .ms-modal-head{padding:18px 20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .ms-modal-head h3{margin:0;font-size:18px;font-weight:700}
    .ms-modal-close{width:36px;height:36px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center}
    .ms-modal-body{padding:16px 20px;overflow-y:auto;flex:1}
    .ms-checkbox{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:background .15s}
    .ms-checkbox:hover{background:#f5f3ff}
    .ms-checkbox input{width:20px;height:20px;accent-color:var(--accent);cursor:pointer}
    .ms-checkbox label{font-size:14px;font-weight:600;cursor:pointer;flex:1}
    .ms-checkbox .ms-color{width:22px;height:22px;border-radius:50%;border:2px solid #ddd;flex-shrink:0}
    .ms-modal-foot{padding:14px 20px;border-top:1px solid #eee;display:flex;gap:10px}
    .ms-modal-foot button{flex:1;padding:12px;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;border:none}
    .ms-apply{background:var(--accent);color:#fff}
    .ms-apply:hover{background:var(--accent-dark)}
    .ms-clear{background:#f3f4f6;color:#555}
    .ms-clear:hover{background:#e5e7eb}
    
    /* Hero cube selected state */
    .hero-cube.selected{border-color:var(--accent);background:rgba(224,161,192,.1);box-shadow:0 4px 16px rgba(224,161,192,.25)}
    .hero-cube.selected::after{content:"\2713";position:absolute;top:8px;left:8px;width:24px;height:24px;background:var(--accent);color:#fff;border-radius:50%;font-size:14px;display:flex;align-items:center;justify-content:center;font-weight:700}
    .hero-color-cube.selected{border-color:var(--accent);background:rgba(224,161,192,.08);position:relative}
    .hero-color-cube.selected::after{content:"\2713";position:absolute;top:2px;left:2px;width:18px;height:18px;background:var(--accent);color:#fff;border-radius:50%;font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:700}
    .hero-color-cube.selected .hero-color-circle{border-color:var(--accent);box-shadow:0 0 0 3px rgba(224,161,192,.3)}
    .hero-cube{position:relative}
    
    /* ===== Hero Discovery Section ===== */
    .hero-discover{width:100%;padding:30px 0 14px;text-align:center;background:#fff;border-bottom:1px solid #eee}
    .hero-discover.hidden{display:none}
    .hero-title{font-size:28px;font-weight:500;color:var(--accent);margin:0 0 26px;padding:0 24px;line-height:1.4}
    .hero-step-label{font-size:21px;font-weight:500;color:#3a3a3a;margin-bottom:20px;padding:0 24px}
    .hero-nav-labels{display:flex;align-items:center;gap:16px;margin-top:12px;justify-content:center;padding:0 24px}
    .hero-nav-btn{display:flex;align-items:center;gap:6px;padding:9px 20px;border-radius:22px;border:1px solid #ddd;background:#fff;cursor:pointer;font-size:14px;font-weight:500;color:var(--muted);transition:all .15s}
    .hero-nav-btn:hover{border-color:var(--accent);color:var(--accent)}
    .hero-nav-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .hero-nav-btn.primary:hover{background:var(--accent-dark)}
    .hero-nav-btn.primary.pulse{animation:heroPulse 1.5s ease-in-out infinite}
    @keyframes heroPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .hero-nav-btn.disabled{opacity:.35;pointer-events:none}
    .hero-no-results{color:#e74c3c;font-size:15px;font-weight:600;margin-top:14px;padding:14px 24px;background:#fff5f5;border-radius:12px;display:inline-block}
    
    /* Scrollable row */
    .hero-slider{position:relative;width:100%;padding:0 56px}
    .hero-cubes{display:flex;gap:20px;overflow-x:auto;scroll-behavior:smooth;padding:10px 12px 20px;-ms-overflow-style:none;scrollbar-width:none;justify-content:flex-start}
    .hero-cubes::-webkit-scrollbar{display:none}
    .hero-cubes.color-grid{flex-wrap:wrap;max-width:1200px;margin:0 auto;justify-content:center;gap:12px;padding:10px 12px 16px}
    .hero-arrow{position:absolute;top:50%;transform:translateY(-50%);width:48px;height:48px;border-radius:50%;background:#fff;border:1px solid #ddd;box-shadow:0 4px 18px rgba(0,0,0,.1);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;font-size:24px;color:#555;transition:all .15s}
    .hero-arrow:hover{box-shadow:0 6px 24px rgba(0,0,0,.18);border-color:var(--accent);color:var(--accent)}
    .hero-arrow-right{right:4px}
    .hero-arrow-left{left:4px}
    
    /* Cubes - HUGE, centered content */
    .hero-cube{min-width:210px;height:220px;border-radius:20px;background:#fff;border:1px solid #e5e5e5;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;transition:all .25s;box-shadow:0 4px 20px rgba(0,0,0,.06);flex-shrink:0}
    .hero-cube:hover{border-color:var(--accent);transform:translateY(-6px);box-shadow:0 14px 45px rgba(224,161,192,.2)}
    .hero-cube.active{border-color:var(--accent);background:linear-gradient(135deg,rgba(224,161,192,.04),rgba(224,161,192,.1));box-shadow:0 8px 30px rgba(224,161,192,.28)}
    .hero-cube-icon{width:100px;height:100px;display:flex;align-items:center;justify-content:center}
    .hero-cube-icon img{max-width:100%;max-height:100%;object-fit:contain}
    .hero-cube-icon svg{width:88px;height:88px;color:var(--accent);stroke-width:1.1}
    .hero-cube-label{font-size:16px;font-weight:600;color:#444;text-align:center;line-height:1.2}
    .hero-cube-sublabel{font-size:12px;font-weight:500;color:#999;text-align:center;margin-top:-6px}
    
    /* Color cubes - 2-row grid layout */
    .hero-color-cube{min-width:100px;width:100px;height:96px;border-radius:14px;background:#fff;border:1px solid #e5e5e5;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;transition:all .25s;box-shadow:0 3px 12px rgba(0,0,0,.05);flex-shrink:0}
    .hero-color-cube:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 8px 24px rgba(224,161,192,.2)}
    .hero-color-cube .hero-color-circle{width:44px;height:44px;border-radius:50%;border:3px solid #e0e0e0;box-shadow:0 3px 8px rgba(0,0,0,.1);transition:all .2s}
    .hero-color-cube:hover .hero-color-circle{border-color:var(--accent)}
    .hero-color-cube .hero-cube-label{font-size:13px;font-weight:600}
    
    /* Price/Size cubes */
    .hero-big-text{font-size:34px;font-weight:900;color:var(--accent)}
    
    @media(max-width:768px){
      .hero-discover{padding:18px 0 8px}
      .hero-title{font-size:19px;padding:0 16px;margin-bottom:16px}
      .hero-step-label{font-size:16px;padding:0 16px;margin-bottom:14px}
      .hero-slider{padding:0 38px}
      .hero-cubes{gap:14px;padding:6px 6px 14px}
      .hero-cube{min-width:150px;height:160px;border-radius:16px;gap:10px}
      .hero-cube-icon{width:72px;height:72px}
      .hero-cube-icon svg{width:64px;height:64px}
      .hero-cube-label{font-size:14px}
      .hero-cubes.color-grid{gap:8px}
      .hero-color-cube{min-width:76px;width:76px;height:76px}
      .hero-color-cube .hero-color-circle{width:34px;height:34px}
      .hero-color-cube .hero-cube-label{font-size:11px}
      .hero-big-text{font-size:26px}
      .hero-arrow{width:34px;height:34px;font-size:17px}
      .hero-arrow-right{right:2px}
      .hero-arrow-left{left:2px}
      .hero-nav-labels{gap:10px}
      .hero-nav-btn{padding:7px 14px;font-size:12px}
    }

    /* ===== AUTH BUTTON IN HEADER ===== */
    .auth-btn{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.4);color:#fff;padding:8px 16px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s;backdrop-filter:blur(4px)}
    .auth-btn:hover{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.7)}
    .auth-btn svg{width:16px;height:16px;flex-shrink:0}
    .auth-btn .auth-name{max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* ===== AUTH MODAL ===== */
    .auth-modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .auth-modal-bg.open{display:flex}
    .auth-modal{background:#fff;border-radius:20px;width:100%;max-width:400px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .auth-modal-head{background:var(--header-gradient);padding:28px 28px 22px;text-align:center}
    .auth-modal-head h2{margin:0;color:#fff;font-size:22px;font-weight:800}
    .auth-modal-head p{margin:6px 0 0;color:rgba(255,255,255,.8);font-size:14px}
    .auth-modal-close{position:absolute;top:14px;left:14px;background:rgba(255,255,255,.2);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
    .auth-modal-body{padding:28px}
    .auth-tabs{display:flex;gap:0;background:#f3f4f6;border-radius:10px;padding:3px;margin-bottom:24px}
    .auth-tab{flex:1;padding:9px;border:none;background:transparent;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;color:#6b7280;transition:all .2s}
    .auth-tab.active{background:#fff;color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.12)}
    .auth-field{margin-bottom:16px}
    .auth-field label{display:block;font-size:12px;font-weight:700;color:#6b7280;margin-bottom:6px}
    .auth-field input{width:100%;border:2px solid #e5e7eb;border-radius:10px;padding:11px 14px;font-size:15px;outline:none;transition:border .2s;box-sizing:border-box}
    .auth-field input:focus{border-color:var(--accent)}
    .auth-submit{width:100%;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:13px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;margin-top:4px}
    .auth-submit:hover{background:var(--accent-dark);transform:translateY(-1px)}
    .auth-submit:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .auth-error{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px;display:none}
    .auth-error.show{display:block}
    .auth-success{background:#f0fdf4;border:1px solid #bbf7d0;color:#16a34a;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px;display:none}
    .auth-success.show{display:block}
    .auth-or{text-align:center;color:#9ca3af;font-size:12px;margin:6px 0 0}
    .auth-logout-btn{width:100%;background:#f9fafb;color:#ef4444;border:1.5px solid #fecaca;border-radius:10px;padding:11px;font-size:14px;font-weight:600;cursor:pointer;margin-top:12px;transition:all .2s}
    .auth-logout-btn:hover{background:#fef2f2}

    /* ===== SAVED PANEL ===== */
    .saved-panel-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:900;justify-content:flex-start}
    .saved-panel-bg.open{display:flex}
    .saved-panel{background:#fff;width:380px;max-width:95vw;height:100%;overflow-y:auto;box-shadow:4px 0 30px rgba(0,0,0,.15);display:flex;flex-direction:column}
    .saved-panel-head{background:var(--header-gradient);padding:20px 20px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
    .saved-panel-head h3{margin:0;color:#fff;font-size:18px;font-weight:800}
    .saved-panel-close{background:rgba(255,255,255,.2);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px}
    .saved-panel-body{flex:1;padding:16px;overflow-y:auto}
    .saved-item{display:flex;gap:12px;padding:12px;border:1px solid #f3f4f6;border-radius:12px;margin-bottom:10px;align-items:center;transition:box-shadow .2s}
    .saved-item:hover{box-shadow:var(--shadow)}
    .saved-item img{width:60px;height:60px;object-fit:cover;border-radius:8px;flex-shrink:0;background:#f3f4f6}
    .saved-item-info{flex:1;min-width:0}
    .saved-item-title{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px}
    .saved-item-price{font-size:13px;font-weight:700;color:var(--accent)}
    .saved-item-store{font-size:11px;color:#9ca3af;margin-top:2px}
    .saved-item-actions{display:flex;flex-direction:column;gap:6px;flex-shrink:0}
    .saved-item-remove{background:none;border:none;color:#9ca3af;cursor:pointer;padding:4px;border-radius:6px;transition:color .2s}
    .saved-item-remove:hover{color:#ef4444}
    .saved-item-buy{background:var(--accent);color:#fff;border:none;padding:6px 10px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;text-decoration:none;display:block;text-align:center}
    .saved-empty{text-align:center;padding:60px 20px;color:#9ca3af}
    .saved-empty svg{width:48px;height:48px;margin:0 auto 12px;display:block;opacity:.35}
    .saved-count{background:rgba(255,255,255,.3);color:#fff;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px}

    /* ===== HEART BUTTON ON CARDS ===== */
    .card-save-btn{position:absolute;top:50px;left:8px;width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.9);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:6;transition:all .2s;backdrop-filter:blur(4px)}
    .card-save-btn:hover{background:#fff;transform:scale(1.1)}
    .card-save-btn svg{width:16px;height:16px;color:#9ca3af;transition:all .2s}
    .card-save-btn.saved svg{color:#ef4444;fill:#ef4444}
    .img-wrap{position:relative}

    /* Profile area in saved panel */
    .user-profile-bar{padding:14px 16px;background:#f9fafb;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;gap:12px}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:16px;flex-shrink:0}
    .user-info .user-email{font-size:13px;font-weight:700;color:var(--text)}
    .user-info .user-plan{font-size:11px;color:#9ca3af;margin-top:2px}
    .user-info .user-plan.premium{color:#f59e0b;font-weight:600}

    /* ===== IMAGE FILTER TOGGLE ===== */
    .img-filter-toggle{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
    .img-filter-label{font-size:14px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px}
    .img-filter-label svg{width:15px;height:15px;color:var(--muted);flex-shrink:0}
    .toggle-switch{position:relative;width:40px;height:22px;flex-shrink:0}
    .toggle-switch input{opacity:0;width:0;height:0;position:absolute}
    .toggle-slider{position:absolute;inset:0;background:#d1d5db;border-radius:22px;cursor:pointer;transition:background .2s}
    .toggle-slider:before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .toggle-switch input:checked + .toggle-slider{background:var(--accent)}
    .toggle-switch input:checked + .toggle-slider:before{transform:translateX(18px)}
    /* hidden card when image blocked */
    .card.img-blocked{display:none}
    .card.img-blocked-mark{opacity:.5}

    /* ===== SPONSORED PRODUCTS ===== */
    .sponsored-strip{padding:0 0 4px}
    .sponsored-label{font-size:11px;font-weight:700;color:#9ca3af;letter-spacing:.5px;text-transform:uppercase;padding:16px 24px 8px;display:flex;align-items:center;gap:6px}
    .sponsored-label svg{width:13px;height:13px}
    .sponsored-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;padding:0 24px 16px}
    @media(max-width:768px){.sponsored-row{grid-template-columns:repeat(2,1fr);padding:0 16px 12px}}
    .sponsored-card{background:#fff;border-radius:10px;overflow:hidden;border:1.5px solid #f0e8f4;box-shadow:0 2px 12px rgba(196,140,179,.1);cursor:pointer;transition:box-shadow .2s;position:relative}
    .sponsored-card:hover{box-shadow:0 6px 24px rgba(196,140,179,.2)}
    .sponsored-badge{position:absolute;top:8px;right:8px;background:rgba(255,255,255,.92);border:1px solid #e5e7eb;color:#9ca3af;font-size:9px;font-weight:700;padding:3px 7px;border-radius:20px;letter-spacing:.3px;backdrop-filter:blur(4px)}
    .sponsored-img{width:100%;aspect-ratio:3/4;object-fit:cover;display:block;background:#f9fafb}
    .sponsored-body{padding:10px 12px}
    .sponsored-title{font-size:12px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px}
    .sponsored-price{font-size:13px;font-weight:800;color:var(--accent)}
    .sponsored-store{font-size:10px;color:#9ca3af;margin-top:2px}
    .sponsored-divider{height:1px;background:#f3f4f6;margin:0 24px}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="header-top">
      <a href="/" class="logo">
        <img src="/lookli-logo.png" alt="LOOKLI" onerror="this.style.display='none'"/>
      </a>
      <nav class="header-nav">
        <a href="/">דף הבית</a>
        <a href="/about.html">אודות</a>
        <a href="/contact.html">צור קשר</a>
        <button class="auth-btn" id="authNavBtn" onclick="openAuthModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          <span class="auth-name" id="authNavLabel">התחברות</span>
        </button>
        <button class="auth-btn" id="savedNavBtn" onclick="openSavedPanel()" style="display:none">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          <span id="savedNavCount"></span>
        </button>
      </nav>
      <button class="mobile-menu-btn" onclick="toggleMobileFilters()">☰</button>
    </div>
    <div class="search-section">
      <div class="search-inner">
        <div class="searchbar">
          <input id="q" placeholder='חפשי: "שמלה שחורה מידה M עד 200 ש"ח"'/>
          <button class="btn" onclick="runAISearch()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          </button>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Active Filters Bar -->
  <div class="active-filters-bar" id="activeFiltersBar">
    <div class="active-filters-inner">
      <span class="active-filters-label">סינון פעיל:</span>
      <div class="active-filters-tags" id="activeFiltersTags"></div>
      <button class="clear-all-btn" onclick="resetAll()">נקה הכל</button>
    </div>
  </div>
  
  <!-- AI analysis removed -->
  <span id="aiAnalysis" style="display:none"></span><span id="aiBox" style="display:none"></span>
  
  <!-- Hero Discovery Section -->
  <div class="hero-discover" id="heroDiscover">
    <h1 class="hero-title">עשרות מותגים &bull; אלפי מוצרים &bull; חיפוש חכם אחד - LOOKLI</h1>
    <div class="hero-step-label" id="heroStepLabel">מה את מחפשת?</div>
    <div class="hero-slider">
      <button class="hero-arrow hero-arrow-right" onclick="heroScroll(1)">‹</button>
      <div class="hero-cubes" id="heroCubes"></div>
      <button class="hero-arrow hero-arrow-left" onclick="heroScroll(-1)">›</button>
    </div>
    <div class="hero-nav-labels" id="heroNavLabels"></div>
    <div id="heroNoResults" style="display:none"></div>
  </div>
  
  <!-- Mobile Filter Button -->
  <button class="mobile-filter-btn" onclick="toggleMobileFilters()">☰</button>
  <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileFilters()"></div>
  
  <div class="wrap">
    <!-- SIDEBAR -->
    <aside class="filters" id="filtersPanel">
      <button class="filter-close-btn" onclick="toggleMobileFilters()">✕</button>
      
      <div class="filter-section open" id="storeSection">
        <div class="filter-header" onclick="toggleFilter('storeSection')">
          <span>חנות</span>
          <span class="arrow">▲</span>
        </div>
        <div class="filter-content">
          <div class="store-opts" id="storeLogos"></div>
        </div>
      </div>
      
      <div class="filter-section open" id="categorySection">
        <div class="filter-header" onclick="toggleFilter('categorySection')">
          <span>סוג מוצר</span>
          <span class="arrow">▲</span>
        </div>
        <div class="filter-content">
          <div class="filter-options" id="categoryBoxes"></div>
        </div>
      </div>
      
      <div class="filter-section" id="colorSection">
        <div class="filter-header" onclick="toggleFilter('colorSection')">
          <span>צבע</span>
          <span class="arrow">▼</span>
        </div>
        <div class="filter-content">
          <div class="color-opts" id="colorGrid"></div>
        </div>
      </div>
      
      <div class="filter-section" id="sizeSection">
        <div class="filter-header" onclick="toggleFilter('sizeSection')">
          <span>מידה</span>
          <span class="arrow">▼</span>
        </div>
        <div class="filter-content">
          <div class="size-opts" id="sizeBoxes"></div>
        </div>
      </div>
      
      <div class="filter-section" id="priceSection">
        <div class="filter-header" onclick="toggleFilter('priceSection')">
          <span>מחיר</span>
          <span class="arrow">▼</span>
        </div>
        <div class="filter-content">
          <div class="price-section">
            <div class="price-display">עד <span id="priceValue">500</span> ₪</div>
            <div class="price-slider">
              <input type="range" id="priceRange" min="50" max="500" step="10" value="500" oninput="updatePriceDisplay()">
            </div>
          </div>
        </div>
      </div>
      
      <div class="filter-section" id="styleSection">
        <div class="filter-header" onclick="toggleFilter('styleSection')">
          <span>סגנון</span>
          <span class="arrow">▼</span>
        </div>
        <div class="filter-content">
          <div class="filter-options" id="styleBoxes"></div>
        </div>
      </div>
      
      <div class="filter-section" id="fitSection">
        <div class="filter-header" onclick="toggleFilter('fitSection')">
          <span>גיזרה</span>
          <span class="arrow">▼</span>
        </div>
        <div class="filter-content">
          <div class="filter-options" id="fitBoxes"></div>
        </div>
      </div>
      
      <div class="filter-section" id="fabricSection">
        <div class="filter-header" onclick="toggleFilter('fabricSection')">
          <span>סוג בד</span>
          <span class="arrow">▼</span>
        </div>
        <div class="filter-content">
          <div class="filter-options" id="fabricBoxes"></div>
        </div>
      </div>
      
      <div class="filter-section" id="patternSection">
        <div class="filter-header" onclick="toggleFilter('patternSection')">
          <span>דוגמא</span>
          <span class="arrow">▼</span>
        </div>
        <div class="filter-content">
          <div class="filter-options" id="patternBoxes"></div>
        </div>
      </div>
      
      <div class="filter-section" id="designSection">
        <div class="filter-header" onclick="toggleFilter('designSection')">
          <span>עיצוב</span>
          <span class="arrow">▼</span>
        </div>
        <div class="filter-content">
          <div class="filter-options" id="designBoxes"></div>
        </div>
      </div>
      
      <div class="filter-section" id="discountSection">
        <div class="filter-header" onclick="toggleFilter('discountSection')">
          <span>הנחה</span>
          <span class="arrow">▼</span>
        </div>
        <div class="filter-content">
          <div class="filter-options" id="discountBoxes"></div>
        </div>
      </div>
      
      <div class="img-filter-toggle">
        <label class="img-filter-label" for="imgAvailToggle">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          תמונה גלויה בלבד
        </label>
        <label class="toggle-switch">
          <input type="checkbox" id="imgAvailToggle" onchange="toggleImgFilter(this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div style="padding:14px 20px">
        <button class="reset-btn" onclick="resetAll()">איפוס הכל</button>
      </div>
      
    </aside>
    
    <!-- MAIN -->
    <main class="main">
      <div class="toolbar">
        <div class="meta" id="metaToolbar">מציג את כל המוצרים</div>
        <select id="sort" onchange="runRegularSearch()" style="padding:8px 12px;border:2px solid var(--border);border-radius:8px;font-size:13px;font-weight:600">
          <option value="new">חדש → ישן</option>
          <option value="price_asc">מחיר ↑</option>
          <option value="price_desc">מחיר ↓</option>
        </select>
      </div>
      <!-- Sponsored Products Strip -->
      <div class="sponsored-strip" id="sponsoredStrip" style="display:none">
        <div class="sponsored-label">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          ממומן
        </div>
        <div class="sponsored-row" id="sponsoredRow"></div>
        <div class="sponsored-divider"></div>
      </div>
      <div class="grid" id="grid"></div>
    </main>
    
    <!-- ADS AREA -->
    <aside class="ads-sidebar">
      <div class="ad-placeholder">מקום<br>לפרסומת</div>
    </aside>
  </div>
  
  <!-- Multi-Select Modal -->
  <div class="ms-modal-bg" id="msModal" onclick="closeMsModal(event)">
    <div class="ms-modal" onclick="event.stopPropagation()">
      <div class="ms-modal-head">
        <h3 id="msModalTitle">בחירה מרובה</h3>
        <button class="ms-modal-close" onclick="closeMsModal()">✕</button>
      </div>
      <div class="ms-modal-body" id="msModalBody"></div>
      <div class="ms-modal-foot">
        <button class="ms-clear" onclick="msClear()">נקה הכל</button>
        <button class="ms-apply" onclick="msApply()">החל סינון</button>
      </div>
    </div>
  </div>
  
  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">פרטי מוצר</div>
        <button class="close-btn" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body">
        <div class="gallery">
          <div class="gallery-carousel" id="modalCarousel">
            <div class="gallery-carousel-inner" id="modalCarouselInner"></div>
            <button class="gallery-nav gallery-prev" onclick="modalCarouselNav(1)">‹</button>
            <button class="gallery-nav gallery-next" onclick="modalCarouselNav(-1)">›</button>
          </div>
          <div class="gallery-dots" id="modalDots"></div>
          <div class="gallery-thumbs" id="modalThumbs"></div>
        </div>
        <div class="details">
          <div class="kpi" id="modalKpi"></div>
          <div class="modal-colors-section">
            <div class="label">צבעים זמינים</div>
            <div class="modal-colors" id="modalColors"></div>
          </div>
          <div>
            <div class="desc-title">פירוט המוצר</div>
            <div class="desc" id="modalDesc"></div>
          </div>
          <div class="buy-big"><a id="modalBuy" href="#" target="_blank"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;vertical-align:middle;margin-left:8px"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>לרכישה באתר</a></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- WhatsApp Button -->
  <a href="https://wa.me/972500000000?text=שלום, פניתי מאתר LOOKLI" target="_blank" class="whatsapp-btn" title="שלחו לנו הודעה בוואטסאפ">
    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
  </a>
  
  <footer>
    <div class="footer-inner">
      <div class="footer-section">
        <div class="footer-brand">LOOKLI</div>
        <p class="footer-desc">מנוע החיפוש החכם לאופנה צנועה.<br>מוצאים את הלוק שלך במקום אחד.</p>
      </div>
      <div class="footer-section">
        <h4>ניווט מהיר</h4>
        <a href="/">דף הבית</a>
        <a href="/about.html">אודות</a>
        <a href="/contact.html">צור קשר</a>
      </div>
      <div class="footer-section">
        <h4>לחנויות</h4>
        <a href="/contact.html?type=store">הצטרפות לאתר</a>
        <a href="/contact.html?type=update">עדכון פרטים</a>
      </div>
      <div class="footer-section">
        <h4>עזרה</h4>
        <a href="/contact.html?type=bug">דיווח על בעיה</a>
        <a href="/about.html#faq">שאלות נפוצות</a>
      </div>
    </div>
    <div class="footer-bottom">
      <span>© 2025 LOOKLI - כל הזכויות שמורות</span>
      <p style="font-size:11px;color:#999;margin:8px auto 0;line-height:1.6;max-width:800px;text-align:center">LOOKLI הוא אתר חיפוש והשוואת מוצרים בלבד. התמונות, המחירים, התיאורים וכל המידע המוצג באתר שייכים לאתרי המקור ולבעלי הזכויות שלהם. אנו אינם מוכרים מוצרים ואיננו אחראים על תוכן, זמינות, מחירים או שירות של אתרי המקור. הרכישה מתבצעת ישירות מול החנות המקורית.</p>
    </div>
  </footer>

<script>
let activeStyle="",activeFit="",activeStore="",activeColor="",activeCategory="",activeDiscount="",activeFabric="",activePattern="",activeSize="",activeDesign="";
let activeColors=[],activeCategories=[],activeSizes=[],activeStyles=[],activeFits=[],activeFabrics=[];
let debounceTimer=null,modalImages=[],modalImageIndex=0,previousSearchQuery="";
let currentPage=1,itemsPerPage=20,allProducts=[],isLoading=false;
let lastSearchKeywords=[];
let dbCategories=[],dbStyles=[],dbFits=[],dbColors=[],dbSizes=[],dbFabrics=[],dbPatterns=[],dbDesigns=[];

const storeLogos={
  'MEKIMI':'https://mekimi.co.il/wp-content/webp-express/webp-images/uploads/2022/10/logo.png.webp',
  'LICHI':'https://lichi-shop.com/wp-content/uploads/2022/03/cropped-Bold-Feminine-Minimalist-Modern-Pink-Logo.png',
  'MIMA':'https://static.wixstatic.com/media/505552_7e2cb98262a1451ca85a0c2dec921d8b~mv2.png/v1/fill/w_272,h_204,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/%D7%9C%D7%95%D7%92%D7%95-%D7%9E%D7%99%D7%9E%D7%94%20%D7%98%D7%95%D7%A8%D7%A7%D7%99%D7%96-01.png',
  'AVIYAH':'https://aviyahyosef.com/wp-content/uploads/2023/09/logo-white.png',
  'CHEMISE':'https://chemise.co.il/wp-content/uploads/2020/11/Group-35.svg'
};

// חנויות שהלוגו שלהן לבן וצריכות רקע כהה
const darkBgStores = new Set(['AVIYAH', 'CHEMISE']);

const colorData={
  'שחור':'#000000','לבן':'#FFFFFF','שמנת':'#FFFDD0','כחול':'#2563EB','תכלת':'#38BDF8',
  'נייבי':'#1E3A5F','אדום':'#DC2626','בורדו':'#800020','ירוק':'#16A34A','זית':'#556B2F',
  'חאקי':'#8B8B00','חום':'#92400E','קאמל':'#C19A6B','בז׳':'#D4B896','ניוד':'#E8BEAC',
  'אפור':'#6B7280','ורוד':'#EC4899','סגול':'#7C3AED','לילך':'#C8A2C8','צהוב':'#FACC15',
  'חרדל':'#FFDB58','כתום':'#EA580C','זהב':'#D4AF37','כסף':'#C0C0C0',
  'פרחוני':'linear-gradient(135deg,#EC4899,#FACC15,#16A34A,#7C3AED)','צבעוני':'linear-gradient(135deg,#DC2626,#FACC15,#2563EB,#16A34A)',
  'מנטה':'#98FFD3','אפרסק':'#FFCBA4','אבן':'#C5B9A8'
};

function getColorHex(n){if(!n)return'#CCC';const t=n.trim();return colorData[t]||Object.entries(colorData).find(([k])=>t.includes(k)||k.includes(t))?.[1]||'#CCC'}
function formatSize(s){return s?s.replace(/^EU_/i,''):s}
function escapeHtml(s){return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
function buildSaveBtn(url, title, price, image, store, isSaved) {
  const cls = 'card-save-btn' + (isSaved ? ' saved' : '');
  const fill = isSaved ? 'currentColor' : 'none';
  const u = url.replace(/"/g,'&quot;');
  const t = title.replace(/"/g,'&quot;');
  const im = image.replace(/"/g,'&quot;');
  const st = store.replace(/"/g,'&quot;');
  return '<button class="'+cls+'" data-url="'+u+'" data-title="'+t+'" data-price="'+price+'" data-image="'+im+'" data-store="'+st+'" title="שמרי מוצר" onclick="event.stopPropagation();handleSaveClick(this)">'
    + '<svg viewBox="0 0 24 24" fill="'+fill+'" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">'
    + '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>'
    + '</svg></button>';
}
function calcDiscount(p,o){return(!o||o<=p)?0:Math.round((o-p)/o*100)}
function debouncedSearch(){clearTimeout(debounceTimer);debounceTimer=setTimeout(runRegularSearch,250)}
function setLoading(){document.getElementById("grid").innerHTML='<div class="card"><div class="img-wrap"></div><div class="card-body"><div style="height:16px;background:#f3f4f6;border-radius:8px;width:80%"></div></div></div>'.repeat(8)}

function toggleMobileFilters(){
  const filters=document.getElementById('filtersPanel');
  const overlay=document.getElementById('mobileOverlay');
  const isOpening=!filters.classList.contains('open');
  filters.classList.toggle('open');
  overlay.classList.toggle('show');
  document.body.style.overflow=filters.classList.contains('open')?'hidden':'';
  if(isOpening){
    filters.scrollTop=0;
    // גלילת הדף לראש כדי שהסיידבר יהיה גלוי
    window.scrollTo({top:0,behavior:'smooth'});
  }
}

function toggleFilter(id){
  const section=document.getElementById(id);
  section.classList.toggle('open');
  const arrow=section.querySelector('.arrow');
  arrow.textContent=section.classList.contains('open')?'▲':'▼';
}

function handleSearchInput(){
  const q=document.getElementById("q").value.trim();
  if(q===""&&previousSearchQuery!==""){
    document.getElementById("aiAnalysis").classList.remove("active");
    resetAllFiltersQuietly();
    lastSearchKeywords=[];
    runRegularSearch();
  }
  previousSearchQuery=q;
}

async function runAISearch(){
  const q=document.getElementById("q").value.trim();
  if(!q){document.getElementById("aiAnalysis").classList.remove("active");lastSearchKeywords=[];runRegularSearch();return}
  setLoading();
  window.scrollTo({top:0,behavior:'smooth'});
  try{
    const res=await fetch("/api/ai-search",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:q})});
    const data=await res.json();
    lastSearchKeywords=data.analysis.keywords||[];
    // Clear all existing filters before applying AI results
    resetAllFiltersQuietly();
    // סנכרון הסיידבר עם תוצאות AI
    if(data.analysis.store){activeStore=data.analysis.store;document.querySelectorAll('.store-opt').forEach(el=>el.classList.toggle('active',el.dataset.store===activeStore))}
    if(data.analysis.color){activeColors=[data.analysis.color]}
    if(data.analysis.category){activeCategories=[data.analysis.category]}
    if(data.analysis.size){activeSizes=[data.analysis.size]}
    if(data.analysis.style){activeStyles=[data.analysis.style]}
    if(data.analysis.fit){activeFits=[data.analysis.fit]}
    if(data.analysis.fabric){activeFabrics=[data.analysis.fabric]}
    if(data.analysis.pattern){activePattern=data.analysis.pattern}
    if(data.analysis.designDetails&&data.analysis.designDetails.length>0){activeDesign=data.analysis.designDetails[0]}
    if(data.analysis.maxPrice){document.getElementById("priceRange").value=Math.min(data.analysis.maxPrice,500);document.getElementById("priceValue").textContent=Math.min(data.analysis.maxPrice,500)}
    // רענון כל הפילטרים ויזואלית
    renderColorGrid();renderCategoryBoxes();renderSizeBoxes();renderStyleBoxes();renderFitBoxes();renderFabricBoxes();renderPatternBoxes();renderDesignBoxes();
    updateActiveFiltersBar();
    allProducts=data.results;currentPage=1;renderPage();
    document.getElementById("metaToolbar").textContent=`${data.count} תוצאות`;
    previousSearchQuery=q;
  }catch(e){console.error(e);alert("שגיאה בחיפוש")}
}

var skipScrollOnSearch=false;

async function runRegularSearch(){
  setLoading();document.getElementById("aiAnalysis").classList.remove("active");
  if(!skipScrollOnSearch){window.scrollTo({top:0,behavior:'smooth'})}
  skipScrollOnSearch=false;
  const params=new URLSearchParams();
  if(lastSearchKeywords.length>0)params.set("q",lastSearchKeywords.join(' '));
  if(activeStore)params.set("store",activeStore);
  // Multi-select: combine single + array selections
  var catVal=activeCategory||(activeCategories.length?activeCategories.join(','):'');
  var colorVal=activeColor||(activeColors.length?activeColors.join(','):'');
  var sizeVal=activeSize||(activeSizes.length?activeSizes.join(','):'');
  var styleVal=activeStyle||(activeStyles.length?activeStyles.join(','):'');
  var fitVal=activeFit||(activeFits.length?activeFits.join(','):'');
  var fabricVal=activeFabric||(activeFabrics.length?activeFabrics.join(','):'');
  if(catVal)params.set("category",catVal);
  if(sizeVal)params.set("size",sizeVal);
  if(colorVal)params.set("color",colorVal);
  if(styleVal)params.set("style",styleVal);
  if(fitVal)params.set("fit",fitVal);
  if(fabricVal)params.set("fabric",fabricVal);
  if(activePattern)params.set("pattern",activePattern);
  if(activeDesign)params.set("design",activeDesign);
  if(activeDiscount)params.set("minDiscount",activeDiscount);
  const maxPrice=document.getElementById("priceRange").value;
  const sliderMax=document.getElementById("priceRange").max;
  if(maxPrice&&parseInt(maxPrice)<parseInt(sliderMax))params.set("maxPrice",maxPrice);
  if(document.getElementById("sort").value)params.set("sort",document.getElementById("sort").value);
  const res=await fetch("/api/products?"+params);
  const data=await res.json();
  allProducts=data;currentPage=1;renderPage();
  document.getElementById("metaToolbar").textContent=`${data.length} מוצרים`;
    updateSeoMeta(document.getElementById("q").value.trim());
    loadSponsored(document.getElementById('q').value.trim());
}

function renderPage(){
  const end=currentPage*itemsPerPage;
  const productsToShow=allProducts.slice(0,end);
  renderProducts(productsToShow,false);
  updateLoadMoreButton();
}

function loadMore(){
  if(isLoading)return;
  currentPage++;
  const start=(currentPage-1)*itemsPerPage;
  const end=currentPage*itemsPerPage;
  const newProducts=allProducts.slice(start,end);
  renderProducts(newProducts,true);
  updateLoadMoreButton();
}

function updateLoadMoreButton(){
  let btn=document.getElementById("loadMoreBtn");
  const totalPages=Math.ceil(allProducts.length/itemsPerPage);
  if(allProducts.length===0||currentPage>=totalPages||allProducts.length<=itemsPerPage){
    if(btn)btn.style.display='none';
  }else{
    if(!btn){btn=document.createElement('button');btn.id='loadMoreBtn';btn.onclick=loadMore;document.getElementById("grid").after(btn)}
    btn.style.display='block';
    btn.textContent='טען עוד';
  }
}

// Infinite scroll - טעינה אוטומטית בגלילה
window.addEventListener('scroll',()=>{
  if(isLoading)return;
  const totalPages=Math.ceil(allProducts.length/itemsPerPage);
  if(currentPage>=totalPages)return;
  const scrollTop=window.scrollY;
  const windowHeight=window.innerHeight;
  const docHeight=document.documentElement.scrollHeight;
  if(scrollTop+windowHeight>=docHeight-300){
    loadMore();
  }
});

function renderProducts(products,append=false){
  const grid=document.getElementById("grid");
  if(!append)grid.innerHTML="";
  if(!products?.length&&!append){grid.innerHTML='<div class="empty">לא נמצאו תוצאות</div>';return}
  
  for(const p of products){
    const store=p.store||"MEKIMI",logo=storeLogos[store]||'';
    const images=(p.images?.length)?p.images:(p.image_url?[p.image_url]:[]);
    const colors=p.colors||(p.color?[p.color]:[]);
    const sizes=(p.sizes||[]).map(formatSize);
    const originalPrice=parseFloat(p.original_price)||0;
    const currentPrice=parseFloat(p.price)||0;
    const isOnSale=originalPrice>0&&originalPrice>currentPrice;
    const disc=calcDiscount(currentPrice,originalPrice);
    
    let carouselHTML='';
    if(images.length>1){
      const slides=images.slice(0,6).map((img,si)=>`<div class="carousel-slide"><img src="${escapeHtml(img)}" alt="" loading="lazy" ${si===0?'onerror="markCardBlocked(this)"':''}>\u200B</div>`).join('');
      const dots=images.slice(0,6).map((_,i)=>`<span class="carousel-dot${i===0?' active':''}" onclick="event.stopPropagation();goToSlide(this,${i})"></span>`).join('');
      carouselHTML=`<div class="carousel" data-index="0"><div class="carousel-inner">${slides}</div><div class="carousel-dots">${dots}</div><button class="carousel-nav carousel-prev" onclick="event.stopPropagation();carouselNav(this,-1)">‹</button><button class="carousel-nav carousel-next" onclick="event.stopPropagation();carouselNav(this,1)">›</button></div>`;
    }else if(images.length===1){
      carouselHTML=`<img src="${escapeHtml(images[0])}" alt="${escapeHtml((p.title||'')+' - '+(p.store||'')+' | LOOKLI')}" style="width:100%;height:100%;object-fit:cover" loading="lazy" onerror="markCardBlocked(this)">`;
    }else{carouselHTML=`<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#ccc;font-size:12px">אין תמונה</div>`}
    
    let colorDotsHTML='';
    if(colors.length>0){
      colorDotsHTML='<div class="card-colors">';
      colors.slice(0,3).forEach(c=>{colorDotsHTML+=`<span class="card-color" style="background:${getColorHex(c)}" title="${escapeHtml(c)}"></span>`});
      if(colors.length>3)colorDotsHTML+=`<span class="card-color-more">+${colors.length-3}</span>`;
      colorDotsHTML+='</div>';
    }
    
    const saleBadgeHTML=isOnSale?`<div class="sale-badge">${disc}%-</div>`:'';
    const priceHTML=isOnSale?`<div class="price-wrap"><div class="price sale">₪${currentPrice}</div><div class="price-original">₪${originalPrice}</div></div>`:`<div class="price">${currentPrice?'₪'+currentPrice:''}</div>`;
    
    let shippingBadgeHTML='';
    if(p.shipping){
      if(p.shipping.isFree){shippingBadgeHTML=`<span class="shipping-badge free">משלוח חינם</span>`}
      else{shippingBadgeHTML=`<span class="shipping-badge">משלוח ₪${p.shipping.cost}</span>`}
    }
    
    const logoBgClass = darkBgStores.has(store) ? 'style="background:#1a1a2e"' : '';
    const isSaved = savedUrls.has(p.source_url||'');
    const saveBtn = buildSaveBtn(p.source_url||'', p.title||'', p.price||0, p.image_url||'', store||'', isSaved);
    grid.innerHTML+=`<div class="card" onclick="openProduct(${p.id})"><div class="img-wrap">${saleBadgeHTML}${carouselHTML}${logo?`<div class="card-logo" ${logoBgClass}><img src="${logo}" alt="${store}"></div>`:''}${colorDotsHTML}${saveBtn}</div><div class="card-body"><div class="title">${escapeHtml(p.title||'')}</div><div class="subrow">${priceHTML}<div class="store">${escapeHtml(store)}</div></div><div class="card-footer"><div class="sizes">${sizes.slice(0,4).join(', ')||'-'}</div>${shippingBadgeHTML}</div></div></div>`;
  }
}

function carouselNav(btn,dir){
  const carousel=btn.closest('.carousel'),inner=carousel.querySelector('.carousel-inner'),slides=carousel.querySelectorAll('.carousel-slide'),dots=carousel.querySelectorAll('.carousel-dot');
  let idx=parseInt(carousel.dataset.index)||0;idx+=dir;if(idx<0)idx=slides.length-1;if(idx>=slides.length)idx=0;
  carousel.dataset.index=idx;inner.style.transform=`translateX(${idx*100}%)`;dots.forEach((d,i)=>d.classList.toggle('active',i===idx));
}
function goToSlide(dot,idx){
  const carousel=dot.closest('.carousel'),inner=carousel.querySelector('.carousel-inner'),dots=carousel.querySelectorAll('.carousel-dot');
  carousel.dataset.index=idx;inner.style.transform=`translateX(${idx*100}%)`;dots.forEach((d,i)=>d.classList.toggle('active',i===idx));
}
function modalCarouselNav(dir){modalImageIndex+=dir;if(modalImageIndex<0)modalImageIndex=modalImages.length-1;if(modalImageIndex>=modalImages.length)modalImageIndex=0;updateModalCarousel()}
function goToModalSlide(idx){modalImageIndex=idx;updateModalCarousel()}
function updateModalCarousel(){
  document.getElementById("modalCarouselInner").style.transform=`translateX(${modalImageIndex*100}%)`;
  document.querySelectorAll('.gallery-dot').forEach((d,i)=>d.classList.toggle('active',i===modalImageIndex));
  document.querySelectorAll('.gallery-thumb').forEach((t,i)=>t.classList.toggle('active',i===modalImageIndex));
}

const allFabrics=['סריג','אריג','ג\'רסי','פיקה','שיפון','קרפ','סאטן','קטיפה','פליז','תחרה','טול','לייקרה','טריקו','רשת','ג\'ינס','קורדרוי','כותנה','פשתן','משי','צמר','ריקמה','פרווה'];
const allPatterns=['פסים','פרחוני','משבצות','נקודות','חלק','הדפס','אבסטרקטי','גיאומטרי','חיות'];
const allDesigns=['צווארון V','צווארון עגול','גולף','צווארון גבוה','צווארון סירה','כפתורים','רוכסן','שרוול ארוך','שרוול קצר','שרוול 3/4','ללא שרוולים','שרוול פעמון','שרוול נפוח','חגורה','קשירה','כיסים','תחרה','פפלום','מלמלה','קפלים','קומות','שסע','כיווצים','תיקתק','מעטפת'];
const allDiscounts=[{val:'20',label:'20%+'},{val:'40',label:'40%+'},{val:'60',label:'60%+'}];

async function initFilters(){
  const data=await(await fetch("/api/filters")).json();
  dbCategories=data.categories||[];dbStyles=data.styles||[];dbFits=data.fits||[];dbColors=data.colors||[];dbSizes=data.sizes||[];dbFabrics=data.fabrics||[];dbPatterns=data.patterns||[];dbDesigns=data.designs||[];
  
  const storeDiv=document.getElementById("storeLogos");
  storeDiv.innerHTML=`<div class="store-opt active" data-store="" onclick="selectStore('')"><span>הכל</span></div>`;
  (data.stores||[]).forEach(s=>{const logo=storeLogos[s];const bgStyle=darkBgStores.has(s)?'style="background:#1a1a2e"':'';storeDiv.innerHTML+=`<div class="store-opt" data-store="${s}" onclick="selectStore('${s}')" ${bgStyle}>${logo?`<img src="${logo}" alt="${s}">`:`<span>${s.substring(0,3)}</span>`}</div>`});
  
  renderCategoryBoxes();renderColorGrid();renderSizeBoxes();renderStyleBoxes();renderFitBoxes();renderFabricBoxes();renderPatternBoxes();renderDesignBoxes();
  
  const discDiv=document.getElementById("discountBoxes");
  discDiv.innerHTML=`<div class="filter-opt${activeDiscount===''?' active':''}" data-discount="" onclick="selectDiscount('')">הכל</div>`+allDiscounts.map(d=>`<div class="filter-opt" data-discount="${d.val}" onclick="selectDiscount('${d.val}')">${d.label}</div>`).join('');
  
  if(data.maxPrice){const slider=document.getElementById("priceRange");const roundedMax=Math.ceil(data.maxPrice/10)*10;slider.max=roundedMax;slider.value=roundedMax;document.getElementById("priceValue").textContent=roundedMax}
}

// Consolidated style map: שבת/ערב includes חגיגי+אלגנטי
var styleConsolidation={'שבת/ערב':['ערב','חגיגי','אלגנטי','שבת','שבתי']};

function renderCategoryBoxes(){const div=document.getElementById("categoryBoxes");var cats=dbCategories.filter(c=>c!=='מכנסיים'&&c!=='סריג');var noSel=!activeCategory&&activeCategories.length===0;div.innerHTML=`<div class="filter-opt${noSel?' active':''}" onclick="selectCategory('')">הכל</div>`+cats.map(c=>{var isA=activeCategory===c||activeCategories.indexOf(c)!==-1;return `<div class="filter-opt${isA?' active':''}" onclick="selectCategory('${escapeHtml(c)}')">${escapeHtml(c)}</div>`}).join('')}
function renderColorGrid(){const div=document.getElementById("colorGrid");var noSel=!activeColor&&activeColors.length===0;div.innerHTML=`<div class="color-opt${noSel?' active':''}" data-color="" style="background:linear-gradient(135deg,#f00,#0f0,#00f,#ff0)" title="הכל" onclick="selectColor('')"></div>`+dbColors.map(c=>{var isA=activeColor===c||activeColors.indexOf(c)!==-1;return `<div class="color-opt${isA?' active':''}" data-color="${escapeHtml(c)}" style="background:${getColorHex(c)}" title="${escapeHtml(c)}" onclick="selectColor('${escapeHtml(c)}')"></div>`}).join('')}
function renderSizeBoxes(){const div=document.getElementById("sizeBoxes");var noSel=!activeSize&&activeSizes.length===0;div.innerHTML=`<div class="size-opt${noSel?' active':''}" onclick="selectSize('')">הכל</div>`+dbSizes.map(s=>{var isA=activeSize===s||activeSizes.indexOf(s)!==-1;return `<div class="size-opt${isA?' active':''}" data-size="${escapeHtml(s)}" onclick="selectSize('${escapeHtml(s)}')">${formatSize(s)}</div>`}).join('')}
function renderStyleBoxes(){const div=document.getElementById("styleBoxes");var consolidated=['שבת/ערב','יום חול','קלאסי','מינימליסטי','מודרני','רטרו','אוברסייז'];var styles=consolidated.filter(s=>s==='שבת/ערב'?dbStyles.some(d=>['ערב','חגיגי','אלגנטי'].includes(d)):dbStyles.includes(s));if(styles.length===0){document.getElementById("styleSection").style.display='none';return}document.getElementById("styleSection").style.display='block';var noSel=!activeStyle&&activeStyles.length===0;div.innerHTML=`<div class="filter-opt${noSel?' active':''}" onclick="selectStyle('')">הכל</div>`+styles.map(s=>{var isA=activeStyle===s||activeStyles.indexOf(s)!==-1;return `<div class="filter-opt${isA?' active':''}" onclick="selectStyle('${escapeHtml(s)}')">${escapeHtml(s)}</div>`}).join('')}
function renderFitBoxes(){const div=document.getElementById("fitBoxes");const baseFits=['ארוכה','מידי','קצרה','מותן','הריון','הנקה'];const allFits=[...new Set([...baseFits,...dbFits])];if(allFits.length===0){document.getElementById("fitSection").style.display='none';return}document.getElementById("fitSection").style.display='block';var noSel=!activeFit&&activeFits.length===0;div.innerHTML=`<div class="filter-opt${noSel?' active':''}" onclick="selectFit('')">הכל</div>`+allFits.map(f=>{var isA=activeFit===f||activeFits.indexOf(f)!==-1;return `<div class="filter-opt${isA?' active':''}" onclick="selectFit('${escapeHtml(f)}')">${escapeHtml(f)}</div>`}).join('')}
function renderFabricBoxes(){const div=document.getElementById("fabricBoxes");if(!dbFabrics||dbFabrics.length===0){document.getElementById("fabricSection").style.display='none';return}document.getElementById("fabricSection").style.display='block';var noSel=!activeFabric&&activeFabrics.length===0;div.innerHTML=`<div class="filter-opt${noSel?' active':''}" onclick="selectFabric('')">הכל</div>`+dbFabrics.map(f=>{var isA=activeFabric===f||activeFabrics.indexOf(f)!==-1;return `<div class="filter-opt${isA?' active':''}" onclick="selectFabric('${escapeHtml(f)}')">${escapeHtml(f)}</div>`}).join('')}
function renderPatternBoxes(){const div=document.getElementById("patternBoxes");if(!dbPatterns||dbPatterns.length===0){document.getElementById("patternSection").style.display='none';return}document.getElementById("patternSection").style.display='block';div.innerHTML=`<div class="filter-opt${activePattern===''?' active':''}" onclick="selectPattern('')">הכל</div>`+dbPatterns.map(p=>`<div class="filter-opt${activePattern===p?' active':''}" onclick="selectPattern('${escapeHtml(p)}')">${escapeHtml(p)}</div>`).join('')}
function renderDesignBoxes(){const div=document.getElementById("designBoxes");if(!dbDesigns||dbDesigns.length===0){document.getElementById("designSection").style.display='none';return}document.getElementById("designSection").style.display='block';div.innerHTML=`<div class="filter-opt${activeDesign===''?' active':''}" onclick="selectDesign('')">הכל</div>`+dbDesigns.map(d=>`<div class="filter-opt${activeDesign===d?' active':''}" onclick="selectDesign('${escapeHtml(d)}')">${escapeHtml(d)}</div>`).join('')}

function updateActiveFiltersBar(){
  const tags=[];
  if(activeStore)tags.push({type:'store',label:'חנות: '+activeStore});
  if(activeCategory)tags.push({type:'category',label:'סוג: '+activeCategory});
  if(activeColor)tags.push({type:'color',label:'צבע: '+activeColor});
  if(activeSize)tags.push({type:'size',label:'מידה: '+formatSize(activeSize)});
  if(activeStyle)tags.push({type:'style',label:'סגנון: '+activeStyle});
  if(activeFit)tags.push({type:'fit',label:'גיזרה: '+activeFit});
  if(activeFabric)tags.push({type:'fabric',label:'בד: '+activeFabric});
  if(activePattern)tags.push({type:'pattern',label:'דוגמא: '+activePattern});
  if(activeDesign)tags.push({type:'design',label:'עיצוב: '+activeDesign});
  if(activeDiscount)tags.push({type:'discount',label:activeDiscount+'%+ הנחה'});
  // Multi-select arrays
  activeCategories.forEach(c=>tags.push({type:'category-'+c,label:'סוג: '+c}));
  activeColors.forEach(c=>tags.push({type:'color-'+c,label:'צבע: '+c}));
  activeSizes.forEach(s=>tags.push({type:'size-'+s,label:'מידה: '+formatSize(s)}));
  activeStyles.forEach(s=>tags.push({type:'style-'+s,label:'סגנון: '+s}));
  activeFits.forEach(f=>tags.push({type:'fit-'+f,label:'גיזרה: '+f}));
  activeFabrics.forEach(f=>tags.push({type:'fabric-'+f,label:'בד: '+f}));
  if(lastSearchKeywords.length>0)tags.push({type:'keywords',label:'חיפוש: '+lastSearchKeywords.join(' ')});
  
  const bar=document.getElementById("activeFiltersBar");
  const tagsDiv=document.getElementById("activeFiltersTags");
  if(tags.length===0){bar.classList.remove('show')}
  else{
    bar.classList.add('show');
    tagsDiv.innerHTML=tags.map(t=>'<span class="filter-tag">'+escapeHtml(t.label)+'<span class="remove-tag" onclick="removeFilter(\''+escapeHtml(t.type)+'\')">✕</span></span>').join('');
  }
}

function removeFilter(type){
  if(type==='store'){activeStore="";document.querySelectorAll('.store-opt').forEach(el=>el.classList.toggle('active',el.dataset.store===''))}
  else if(type==='category'){activeCategory="";renderCategoryBoxes()}
  else if(type==='color'){activeColor="";renderColorGrid()}
  else if(type==='size'){activeSize="";renderSizeBoxes()}
  else if(type==='style'){activeStyle="";renderStyleBoxes()}
  else if(type==='fit'){activeFit="";renderFitBoxes()}
  else if(type==='fabric'){activeFabric="";renderFabricBoxes()}
  else if(type==='pattern'){activePattern="";renderPatternBoxes()}
  else if(type==='design'){activeDesign="";renderDesignBoxes()}
  else if(type==='discount'){activeDiscount="";document.querySelectorAll('#discountBoxes .filter-opt').forEach(el=>el.classList.toggle('active',el.dataset.discount===''))}
  else if(type==='keywords'){lastSearchKeywords=[];document.getElementById("q").value=""}
  else if(type.startsWith('category-')){var v=type.substring(9);activeCategories=activeCategories.filter(x=>x!==v)}
  else if(type.startsWith('color-')){var v2=type.substring(6);activeColors=activeColors.filter(x=>x!==v2)}
  else if(type.startsWith('size-')){var v3=type.substring(5);activeSizes=activeSizes.filter(x=>x!==v3)}
  else if(type.startsWith('style-')){var v4=type.substring(6);activeStyles=activeStyles.filter(x=>x!==v4)}
  else if(type.startsWith('fit-')){var v5=type.substring(4);activeFits=activeFits.filter(x=>x!==v5)}
  else if(type.startsWith('fabric-')){var v6=type.substring(7);activeFabrics=activeFabrics.filter(x=>x!==v6)}
  updateActiveFiltersBar();
  runRegularSearch();
}

function updatePriceDisplay(){const val=document.getElementById("priceRange").value;document.getElementById("priceValue").textContent=val;debouncedSearch()}

function selectStore(s){activeStore=(activeStore===s&&s!=="")?"":s;document.querySelectorAll('.store-opt').forEach(el=>el.classList.toggle('active',el.dataset.store===activeStore));updateActiveFiltersBar();runRegularSearch()}
function selectCategory(c){checkHideHero();if(!c){activeCategory='';activeCategories=[];}else{activeCategory='';var idx=activeCategories.indexOf(c);if(idx!==-1)activeCategories.splice(idx,1);else activeCategories.push(c);}renderCategoryBoxes();updateActiveFiltersBar();runRegularSearch()}
function selectColor(c){checkHideHero();if(!c){activeColor='';activeColors=[];}else{activeColor='';var idx=activeColors.indexOf(c);if(idx!==-1)activeColors.splice(idx,1);else activeColors.push(c);}renderColorGrid();updateActiveFiltersBar();runRegularSearch()}
function selectSize(s){checkHideHero();if(!s){activeSize='';activeSizes=[];}else{activeSize='';var idx=activeSizes.indexOf(s);if(idx!==-1)activeSizes.splice(idx,1);else activeSizes.push(s);}renderSizeBoxes();updateActiveFiltersBar();runRegularSearch()}
function selectStyle(s){checkHideHero();if(!s){activeStyle='';activeStyles=[];}else{activeStyle='';var idx=activeStyles.indexOf(s);if(idx!==-1)activeStyles.splice(idx,1);else activeStyles.push(s);}renderStyleBoxes();updateActiveFiltersBar();runRegularSearch()}
function selectFit(f){checkHideHero();if(!f){activeFit='';activeFits=[];}else{activeFit='';var idx=activeFits.indexOf(f);if(idx!==-1)activeFits.splice(idx,1);else activeFits.push(f);}renderFitBoxes();updateActiveFiltersBar();runRegularSearch()}
function selectFabric(f){checkHideHero();if(!f){activeFabric='';activeFabrics=[];}else{activeFabric='';var idx=activeFabrics.indexOf(f);if(idx!==-1)activeFabrics.splice(idx,1);else activeFabrics.push(f);}renderFabricBoxes();updateActiveFiltersBar();runRegularSearch()}
function selectPattern(p){activePattern=(activePattern===p)?"":p;renderPatternBoxes();updateActiveFiltersBar();runRegularSearch()}
function selectDesign(d){activeDesign=(activeDesign===d)?"":d;renderDesignBoxes();updateActiveFiltersBar();runRegularSearch()}
function selectDiscount(d){activeDiscount=(activeDiscount===d)?"":d;document.querySelectorAll('#discountBoxes .filter-opt').forEach(el=>el.classList.toggle('active',el.dataset.discount===activeDiscount));updateActiveFiltersBar();runRegularSearch()}

// === Multi-Select Modal ===
var msCurrentType='';
var msSelected=[];
function openMsModal(type){
  msCurrentType=type;
  var items=[],title='';
  if(type==='category'){title='בחירת סוגי מוצר';items=dbCategories.filter(c=>c!=='מכנסיים');msSelected=activeCategory?[activeCategory]:[...activeCategories]}
  else if(type==='color'){title='בחירת צבעים';items=dbColors;msSelected=activeColor?[activeColor]:[...activeColors]}
  else if(type==='size'){title='בחירת מידות';items=dbSizes;msSelected=activeSize?[activeSize]:[...activeSizes]}
  else if(type==='style'){title='בחירת סגנונות';items=['שבת/ערב','יום חול','קלאסי','מינימליסטי','מודרני','רטרו','אוברסייז'];msSelected=activeStyle?[activeStyle]:[...activeStyles]}
  else if(type==='fit'){title='בחירת גיזרות';items=['ארוכה','מידי','קצרה','מותן','הריון','הנקה'];msSelected=activeFit?[activeFit]:[...activeFits]}
  else if(type==='fabric'){title='בחירת סוגי בד';items=dbFabrics;msSelected=activeFabric?[activeFabric]:[...activeFabrics]}
  document.getElementById('msModalTitle').textContent=title;
  var body=document.getElementById('msModalBody');
  body.innerHTML=items.map(function(item){
    var checked=msSelected.indexOf(item)!==-1?'checked':'';
    var extra=type==='color'?'<span class="ms-color" style="background:'+getColorHex(item)+'"></span>':'';
    return '<label class="ms-checkbox"><input type="checkbox" value="'+escapeHtml(item)+'" '+checked+' onchange="msToggle(this)"/>'+extra+'<span>'+escapeHtml(type==='size'?formatSize(item):item)+'</span></label>';
  }).join('');
  document.getElementById('msModal').classList.add('open');
}
function closeMsModal(e){if(e&&e.target!==e.currentTarget)return;document.getElementById('msModal').classList.remove('open')}
function msToggle(cb){var v=cb.value;if(cb.checked){if(msSelected.indexOf(v)===-1)msSelected.push(v)}else{msSelected=msSelected.filter(x=>x!==v)}}
function msClear(){msSelected=[];document.querySelectorAll('#msModalBody input').forEach(cb=>{cb.checked=false})}
function msApply(){
  if(msCurrentType==='category'){activeCategory='';activeCategories=msSelected.length===1?[]:msSelected.slice();if(msSelected.length===1)activeCategory=msSelected[0];renderCategoryBoxes()}
  else if(msCurrentType==='color'){activeColor='';activeColors=msSelected.length===1?[]:msSelected.slice();if(msSelected.length===1)activeColor=msSelected[0];renderColorGrid()}
  else if(msCurrentType==='size'){activeSize='';activeSizes=msSelected.length===1?[]:msSelected.slice();if(msSelected.length===1)activeSize=msSelected[0];renderSizeBoxes()}
  else if(msCurrentType==='style'){activeStyle='';activeStyles=msSelected.length===1?[]:msSelected.slice();if(msSelected.length===1)activeStyle=msSelected[0];renderStyleBoxes()}
  else if(msCurrentType==='fit'){activeFit='';activeFits=msSelected.length===1?[]:msSelected.slice();if(msSelected.length===1)activeFit=msSelected[0];renderFitBoxes()}
  else if(msCurrentType==='fabric'){activeFabric='';activeFabrics=msSelected.length===1?[]:msSelected.slice();if(msSelected.length===1)activeFabric=msSelected[0];renderFabricBoxes()}
  updateActiveFiltersBar();
  runRegularSearch();
  closeMsModal();
}

function resetAllFiltersQuietly(){
  activeStore="";activeCategory="";activeColor="";activeStyle="";activeFit="";activeDiscount="";activeFabric="";activePattern="";activeSize="";activeDesign="";
  activeCategories=[];activeColors=[];activeSizes=[];activeStyles=[];activeFits=[];activeFabrics=[];
  const slider=document.getElementById("priceRange");slider.value=slider.max;document.getElementById("priceValue").textContent=slider.max;
  document.querySelectorAll(".store-opt").forEach(el=>el.classList.toggle('active',el.dataset.store===''));
  renderCategoryBoxes();renderColorGrid();renderSizeBoxes();renderStyleBoxes();renderFitBoxes();renderFabricBoxes();renderPatternBoxes();renderDesignBoxes();
  document.querySelectorAll('#discountBoxes .filter-opt').forEach(el=>el.classList.toggle('active',el.dataset.discount===''));
  document.getElementById("activeFiltersBar").classList.remove('show');
}

function resetAll(){
  filterImgAvail=false;
  const tog=document.getElementById('imgAvailToggle');
  if(tog)tog.checked=false;
  document.querySelectorAll('.card.img-blocked').forEach(c=>c.classList.remove('img-blocked'));document.getElementById("q").value="";previousSearchQuery="";lastSearchKeywords=[];resetAllFiltersQuietly();document.getElementById("aiAnalysis").classList.remove("active");runRegularSearch()}

async function openProduct(id){
  document.getElementById("modalBackdrop").classList.add("open");
  document.getElementById("modalTitle").textContent="טוען…";
  document.getElementById("modalDesc").textContent="";
  document.getElementById("modalKpi").innerHTML="";
  document.getElementById("modalColors").innerHTML="";
  document.getElementById("modalThumbs").innerHTML="";
  document.getElementById("modalCarouselInner").innerHTML="";
  document.getElementById("modalDots").innerHTML="";
  try{
    const p=await(await fetch("/api/product/"+id)).json();
    document.getElementById("modalTitle").textContent=p.title||"מוצר";
    document.getElementById("modalBuy").href="/out/"+id;
    document.getElementById("modalDesc").textContent=(p.description||"").replace(/\r\n/g,'\n').replace(/\r/g,'\n')||"אין תיאור נוסף";
    modalImages=(p.images?.length)?p.images:(p.image_url?[p.image_url]:[]);modalImageIndex=0;
    document.getElementById("modalCarouselInner").innerHTML=modalImages.map(img=>`<div class="gallery-carousel-slide"><img src="${escapeHtml(img)}" alt=""></div>`).join('');
    document.getElementById("modalDots").innerHTML=modalImages.map((_,i)=>`<button class="gallery-dot${i===0?' active':''}" onclick="goToModalSlide(${i})"></button>`).join('');
    document.getElementById("modalThumbs").innerHTML=modalImages.map((img,i)=>`<div class="gallery-thumb${i===0?' active':''}" onclick="goToModalSlide(${i})"><img src="${escapeHtml(img)}" loading="lazy"></div>`).join('');
    
    const kpis=[],isOnSale=p.original_price&&p.original_price>p.price,disc=calcDiscount(p.price,p.original_price);
    if(p.store)kpis.push(`<span>חנות: ${escapeHtml(p.store)}</span>`);
    if(isOnSale){kpis.push(`<span class="sale-kpi">₪${p.price} <s>₪${p.original_price}</s> (${disc}%-)</span>`)}else if(p.price){kpis.push(`<span>מחיר: ₪${p.price}</span>`)}
    if(p.sizes?.length)kpis.push(`<span>מידות: ${p.sizes.map(formatSize).join(', ')}</span>`);
    if(p.category)kpis.push(`<span>סוג: ${escapeHtml(p.category)}</span>`);
    if(p.shipping){if(p.shipping.isFree){kpis.push(`<span class="shipping-kpi free">משלוח חינם</span>`)}else{kpis.push(`<span class="shipping-kpi">משלוח ₪${p.shipping.cost} (חינם מעל ₪${p.shipping.threshold})</span>`)}}
    document.getElementById("modalKpi").innerHTML=kpis.join("");
    
    const colors=p.colors||(p.color?[p.color]:[]);
    const colorsDiv=document.getElementById("modalColors");
    if(colors.length){colors.forEach(c=>{colorsDiv.innerHTML+=`<span class="modal-color" style="background:${getColorHex(c)}" title="${escapeHtml(c)}"></span>`})}else{colorsDiv.innerHTML='<span style="color:#999;font-size:12px">לא צוין</span>'}
  }catch(e){document.getElementById("modalTitle").textContent="שגיאה בטעינה"}
}

function closeModal(e){if(e&&e.target!==e.currentTarget)return;document.getElementById("modalBackdrop").classList.remove("open")}

document.getElementById("q").addEventListener("input",handleSearchInput);
document.getElementById("q").addEventListener("keypress",e=>{if(e.key==="Enter")runAISearch()});

// === Hero Discovery Flow ===
var heroStep='category';
var heroSteps=['category','color','price','size','fit','fabric','done'];
var heroStepNames={'category':'סוג מוצר','color':'צבע','price':'תקציב','size':'מידה','fit':'גיזרה','fabric':'סוג בד','done':''};
var heroNoResultsFlag=false;
var sizeToNumbers={'XS':'34-36','S':'36-38','M':'38-40','L':'40-42','XL':'42-44','XXL':'44-46','XXXL':'46-48','ONE SIZE':'מידה אחת'};

function heroScroll(dir){
  var c=document.getElementById('heroCubes');
  c.scrollBy({left:dir*300,behavior:'smooth'});
}

// Icon: try /icons/NAME.png first, fallback to SVG
function heroIconHtml(name,svgFB){
  var safeName=name.replace(/\//g,'-');
  var safe=encodeURIComponent(safeName);
  var encoded=btoa(unescape(encodeURIComponent(svgFB)));
  return '<div class="hero-cube-icon"><img src="/icons/'+safe+'.png" onerror="this.onerror=null;this.parentElement.innerHTML=decodeURIComponent(escape(atob(\''+encoded+'\')));" /></div>';
}

// Minimal SVG fallbacks (only used if no .png in /icons/)
var defaultSvg='<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><rect x="14" y="14" width="36" height="36" rx="8"/></svg>';
var catSvg={
'שמלה':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M24 6h16l3 10-7 4v34H28V20l-7-4 3-10z"/><path d="M24 6c-1 0-3 1-4 3l-6 11 7 4"/><path d="M40 6c1 0 3 1 4 3l6 11-7 4"/></svg>',
'חולצה':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M22 8h20v4l2 2v34H20V14l2-2V8z"/><path d="M22 8l-8 6-4 12h6l4-6"/><path d="M42 8l8 6 4 12h-6l-4-6"/><path d="M28 8a4 4 0 008 0"/></svg>',
'חצאית':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M20 12h24v4l4 38H16l4-38v-4z"/><line x1="20" y1="16" x2="44" y2="16"/></svg>',
'סט':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M22 6h20l2 2v18H20V8l2-2z"/><path d="M22 6l-6 5-3 9h5l4-5"/><path d="M42 6l6 5 3 9h-5l-4-5"/><path d="M20 30h24v4l3 24H17l3-24v-4z"/></svg>',
'בייסיק':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M20 12h24v40H20V12z" rx="2"/><path d="M20 12l-6 5v22l6 3"/><path d="M44 12l6 5v22l-6 3"/></svg>',
'קרדיגן':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M32 8v44"/><path d="M22 8h10v44H18V16z"/><path d="M42 8H32v44h14V16z"/><path d="M22 8l-8 6-4 16h6l4-8"/><path d="M42 8l8 6 4 16h-6l-4-8"/></svg>',
'מעיל':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M22 8h20l2 2v42H20V10l2-2z"/><path d="M22 8l-9 6-5 18h8l4-8"/><path d="M42 8l9 6 5 18h-8l-4-8"/><path d="M32 8v44"/></svg>',
'טוניקה':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M24 8h16l2 2v38c0 2-4 4-10 4s-10-2-10-4V10l2-2z"/><path d="M24 8l-7 5-3 14h5l3-6"/><path d="M40 8l7 5 3 14h-5l-3-6"/></svg>',
'סוודר':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M20 14h24v34H20V14z" rx="2"/><path d="M20 14c0-3 5-6 12-6s12 3 12 6"/><path d="M20 16l-8 4v14l8 4"/><path d="M44 16l8 4v14l-8 4"/></svg>',
'מכנסיים':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M18 10h28v8l-4 38h-8l-2-28-2 28h-8l-4-38v-8z"/><line x1="18" y1="14" x2="46" y2="14"/></svg>',
'עליונית':'<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M20 14h24v30H20V14z" rx="2"/><path d="M20 14l-7 4v10l7 4"/><path d="M44 14l7 4v10l-7 4"/></svg>',
};
function getSvg(name){return catSvg[name]||defaultSvg}

function renderHeroNav(){
  var nav=document.getElementById('heroNavLabels');
  var idx=heroSteps.indexOf(heroStep);
  var prevStep=idx>0?heroSteps[idx-1]:null;
  var nextStep=(idx<heroSteps.length-1)?heroSteps[idx+1]:null;
  var h='';
  if(prevStep&&heroStepNames[prevStep]){
    h+='<button class="hero-nav-btn" onclick="heroPrevStep()">'+heroStepNames[prevStep]+' \u2192 \u05D7\u05D6\u05E8\u05D4</button>';
  }
  // Count current selections
  var count=heroGetCurrentSelections().length;
  if(nextStep&&heroStepNames[nextStep]&&!heroNoResultsFlag){
    h+='<button class="hero-nav-btn primary'+(count>0?' pulse':'')+'" onclick="heroAdvanceStep()" style="'+(count>0?'font-size:16px;padding:12px 28px;':'')+'">'+heroStepNames[nextStep]+' \u2190'+(count>0?' ('+count+' \u05E0\u05D1\u05D7\u05E8\u05D5)':'')+'</button>';
  } else if(heroStep!=='category'&&!heroNoResultsFlag){
    h+='<button class="hero-nav-btn primary'+(count>0?' pulse':'')+'" onclick="heroAdvanceStep()" style="font-size:16px;padding:12px 28px;">\u05E1\u05D9\u05D5\u05DD \u2713</button>';
  }
  nav.innerHTML=h;
}

function heroGetCurrentSelections(){
  if(heroStep==='category')return activeCategories.length?activeCategories:(activeCategory?[activeCategory]:[]);
  if(heroStep==='color')return activeColors.length?activeColors:(activeColor?[activeColor]:[]);
  if(heroStep==='size')return activeSizes.length?activeSizes:(activeSize?[activeSize]:[]);
  if(heroStep==='style')return activeStyles.length?activeStyles:(activeStyle?[activeStyle]:[]);
  if(heroStep==='fit')return activeFits.length?activeFits:(activeFit?[activeFit]:[]);
  if(heroStep==='fabric')return activeFabrics.length?activeFabrics:(activeFabric?[activeFabric]:[]);
  return [];
}

function renderHeroNav(){
  var nav=document.getElementById('heroNavLabels');
  var idx=heroSteps.indexOf(heroStep);
  var prevStep=idx>0?heroSteps[idx-1]:null;
  var nextStep=(idx<heroSteps.length-1)?heroSteps[idx+1]:null;
  var h='';
  if(prevStep&&heroStepNames[prevStep]){
    h+='<button class="hero-nav-btn" onclick="heroPrevStep()">\u2192 '+heroStepNames[prevStep]+'</button>';
  }
  var count=heroGetCurrentSelections().length;
  if(nextStep&&heroStepNames[nextStep]&&!heroNoResultsFlag){
    h+='<button class="hero-nav-btn primary'+(count>0?' pulse':'')+'" onclick="heroAdvanceStep()" style="'+(count>0?'font-size:16px;padding:12px 28px;box-shadow:0 4px 16px rgba(144,97,249,.3);':'')+'">'+heroStepNames[nextStep]+' \u2190'+(count>0?' ('+count+')':'')+'</button>';
  } else if(heroStep!=='category'&&!heroNoResultsFlag&&idx>=heroSteps.length-2){
    h+='<button class="hero-nav-btn primary pulse" onclick="heroAdvanceStep()" style="font-size:16px;padding:12px 28px;box-shadow:0 4px 16px rgba(144,97,249,.3);">\u05E1\u05D9\u05D5\u05DD \u2713</button>';
  }
  nav.innerHTML=h;
}

function renderHeroStep(){
  var cubesDiv=document.getElementById('heroCubes');
  var labelDiv=document.getElementById('heroStepLabel');
  var noResDiv=document.getElementById('heroNoResults');
  noResDiv.style.display='none';
  cubesDiv.className='hero-cubes';
  heroNoResultsFlag=false;
  var sel=heroGetCurrentSelections();
  
  if(heroStep==='category'){
    labelDiv.textContent='\u05DE\u05D4 \u05D0\u05EA \u05DE\u05D7\u05E4\u05E9\u05EA?';
    var cats=['שמלה','חולצה','חצאית','סט','בייסיק','קרדיגן','מעיל','טוניקה','סוודר','עליונית'];
    if(dbCategories.length>0){var o=[];cats.forEach(function(c){if(dbCategories.indexOf(c)!==-1)o.push(c)});dbCategories.forEach(function(c){if(o.indexOf(c)===-1&&c!=='מכנסיים'&&c!=='סריג')o.push(c)});cats=o}
    cubesDiv.innerHTML=cats.map(function(c){var is=sel.indexOf(c)!==-1;return '<div class="hero-cube'+(is?' selected':'')+'" onclick="heroToggle(\'category\',\''+escapeHtml(c)+'\',this)">'+heroIconHtml(c,getSvg(c))+'<span class="hero-cube-label">'+escapeHtml(c)+'</span></div>'}).join('');
    
  } else if(heroStep==='color'){
    labelDiv.textContent='\u05D1\u05D0\u05D9\u05D6\u05D4 \u05E6\u05D1\u05E2?';
    cubesDiv.className='hero-cubes color-grid';
    var pop=['שחור','לבן','כחול','אדום','ורוד','בז׳','שמנת','אפור','ירוק','חום','בורדו','סגול','אבן','קאמל','ניוד','צהוב','כתום','לילך','תכלת','זהב'];
    var colors=dbColors.length>0?dbColors:pop;
    if(dbColors.length>0){var o2=[];pop.forEach(function(c){if(colors.indexOf(c)!==-1)o2.push(c)});colors.forEach(function(c){if(o2.indexOf(c)===-1)o2.push(c)});colors=o2}
    cubesDiv.innerHTML=colors.map(function(c){var is=sel.indexOf(c)!==-1;return '<div class="hero-color-cube'+(is?' selected':'')+'" onclick="heroToggle(\'color\',\''+escapeHtml(c)+'\',this)"><div class="hero-color-circle" style="background:'+getColorHex(c)+'"></div><span class="hero-cube-label">'+escapeHtml(c)+'</span></div>'}).join('');
    
  } else if(heroStep==='price'){
    labelDiv.textContent='\u05D1\u05D0\u05D9\u05D6\u05D4 \u05EA\u05E7\u05E6\u05D9\u05D1?';
    var prices=[{v:'100',l:'\u05E2\u05D3 \u20AA100'},{v:'150',l:'\u05E2\u05D3 \u20AA150'},{v:'200',l:'\u05E2\u05D3 \u20AA200'},{v:'300',l:'\u05E2\u05D3 \u20AA300'},{v:'500',l:'\u05E2\u05D3 \u20AA500'},{v:'',l:'\u05DC\u05DC\u05D0 \u05D4\u05D2\u05D1\u05DC\u05D4'}];
    cubesDiv.innerHTML=prices.map(function(p){return '<div class="hero-cube" onclick="heroSelectPrice(\''+p.v+'\')"><span class="hero-big-text">'+(p.v?'\u20AA'+p.v:'\u221E')+'</span><span class="hero-cube-label">'+p.l+'</span></div>'}).join('');
    
  } else if(heroStep==='size'){
    labelDiv.textContent='\u05DE\u05D4 \u05D4\u05DE\u05D9\u05D3\u05D4 \u05E9\u05DC\u05DA?';
    var popS=['S','M','L','XL','XS','XXL','XXXL','ONE SIZE'];
    var sizes=dbSizes.length>0?dbSizes:popS;
    if(dbSizes.length>0){var o3=[];popS.forEach(function(s){if(sizes.indexOf(s)!==-1)o3.push(s)});sizes.forEach(function(s){if(o3.indexOf(s)===-1)o3.push(s)});sizes=o3}
    cubesDiv.innerHTML=sizes.map(function(s){var nums=sizeToNumbers[s]||'';var is=sel.indexOf(s)!==-1;return '<div class="hero-cube'+(is?' selected':'')+'" onclick="heroToggle(\'size\',\''+escapeHtml(s)+'\',this)"><span class="hero-big-text">'+formatSize(s)+'</span><span class="hero-cube-label">\u05DE\u05D9\u05D3\u05D4 '+formatSize(s)+'</span>'+(nums?'<span class="hero-cube-sublabel">'+nums+'</span>':'')+'</div>'}).join('');
    
  } else if(heroStep==='style'){
    if(!dbStyles||dbStyles.length===0){heroStep='fit';renderHeroStep();return}
    labelDiv.textContent='\u05D0\u05D9\u05D6\u05D4 \u05E1\u05D2\u05E0\u05D5\u05DF?';
    var consolidated=['שבת/ערב','יום חול','קלאסי','מינימליסטי','אוברסייז'];
    var styles=consolidated.filter(function(s){return s==='שבת/ערב'?dbStyles.some(function(d){return ['ערב','חגיגי','אלגנטי'].indexOf(d)!==-1}):dbStyles.indexOf(s)!==-1});
    if(styles.length===0){heroStep='fit';renderHeroStep();return}
    cubesDiv.innerHTML=styles.map(function(s){var is=sel.indexOf(s)!==-1;return '<div class="hero-cube'+(is?' selected':'')+'" onclick="heroToggle(\'style\',\''+escapeHtml(s)+'\',this)">'+heroIconHtml(s,defaultSvg)+'<span class="hero-cube-label">'+escapeHtml(s)+'</span></div>'}).join('');
    
  } else if(heroStep==='fit'){
    var popF=['ארוכה','מידי','קצרה','מותן','הריון','הנקה','מעטפת'];
    var avail=popF.slice();
    if(dbFits.length>0){dbFits.forEach(function(f){if(avail.indexOf(f)===-1)avail.push(f)})}
    labelDiv.textContent='\u05D0\u05D9\u05D6\u05D5 \u05D2\u05D9\u05D6\u05E8\u05D4?';
    cubesDiv.innerHTML=avail.map(function(f){var is=sel.indexOf(f)!==-1;return '<div class="hero-cube'+(is?' selected':'')+'" onclick="heroToggle(\'fit\',\''+escapeHtml(f)+'\',this)">'+heroIconHtml(f,defaultSvg)+'<span class="hero-cube-label">'+escapeHtml(f)+'</span></div>'}).join('');
    
  } else if(heroStep==='fabric'){
    if(!dbFabrics||dbFabrics.length===0){heroStep='done';renderHeroStep();return}
    var popFab=['סריג','שיפון','כותנה','סאטן','תחרה','קטיפה','פשתן','פרווה','משי','צמר'];
    var fabrics=dbFabrics;var o5=[];popFab.forEach(function(f){if(fabrics.indexOf(f)!==-1)o5.push(f)});fabrics.forEach(function(f){if(o5.indexOf(f)===-1)o5.push(f)});
    labelDiv.textContent='\u05E1\u05D5\u05D2 \u05D1\u05D3?';
    cubesDiv.innerHTML=o5.map(function(f){var is=sel.indexOf(f)!==-1;return '<div class="hero-cube'+(is?' selected':'')+'" onclick="heroToggle(\'fabric\',\''+escapeHtml(f)+'\',this)">'+heroIconHtml(f,defaultSvg)+'<span class="hero-cube-label">'+escapeHtml(f)+'</span></div>'}).join('');
    
  } else {
    document.getElementById('heroDiscover').classList.add('hidden');
    renderHeroNav();
    return;
  }
  if(heroStep!=='color'){setTimeout(function(){cubesDiv.scrollLeft=cubesDiv.scrollWidth},50)}
  renderHeroNav();
}

// Toggle a cube selection (multi-select) - does NOT auto-advance
function heroToggle(type,val,el){
  var arr,setArr;
  if(type==='category'){arr=activeCategories;activeCategory=''}
  else if(type==='color'){arr=activeColors;activeColor=''}
  else if(type==='size'){arr=activeSizes;activeSize=''}
  else if(type==='style'){arr=activeStyles;activeStyle=''}
  else if(type==='fit'){arr=activeFits;activeFit=''}
  else if(type==='fabric'){arr=activeFabrics;activeFabric=''}
  else return;
  
  var idx=arr.indexOf(val);
  if(idx!==-1){arr.splice(idx,1);el.classList.remove('selected')}
  else{arr.push(val);el.classList.add('selected')}
  
  // Sync sidebar
  if(type==='category'){activeCategories=arr;renderCategoryBoxes()}
  if(type==='color'){activeColors=arr;renderColorGrid()}
  if(type==='size'){activeSizes=arr;renderSizeBoxes()}
  if(type==='style'){activeStyles=arr;renderStyleBoxes()}
  if(type==='fit'){activeFits=arr;renderFitBoxes()}
  if(type==='fabric'){activeFabrics=arr;renderFabricBoxes()}
  
  updateActiveFiltersBar();
  skipScrollOnSearch=true;
  runRegularSearch();
  renderHeroNav();
}

// Price is still single-select with auto-advance
function heroSelectPrice(val){
  if(val){document.getElementById("priceRange").value=parseInt(val);document.getElementById("priceValue").textContent=val}
  updateActiveFiltersBar();
  heroAdvanceStep();
}

// Called by the prominent "next" button
async function heroAdvanceStep(){
  skipScrollOnSearch=true;
  await runRegularSearch();
  var noResDiv=document.getElementById('heroNoResults');
  if(allProducts.length===0){
    heroNoResultsFlag=true;
    noResDiv.innerHTML='<div class="hero-no-results">\u05DC\u05D0 \u05E0\u05DE\u05E6\u05D0\u05D5 \u05DE\u05D5\u05E6\u05E8\u05D9\u05DD \u05E2\u05DD \u05D4\u05E9\u05D9\u05DC\u05D5\u05D1 \u05D4\u05D6\u05D4. \u05E0\u05E1\u05D9 \u05DC\u05D7\u05D6\u05D5\u05E8 \u05D0\u05D7\u05D5\u05E8\u05D4 \u05D5\u05DC\u05E9\u05E0\u05D5\u05EA \u05D1\u05D7\u05D9\u05E8\u05D4.</div>';
    noResDiv.style.display='block';
    renderHeroNav();
  } else {
    heroNoResultsFlag=false;
    noResDiv.style.display='none';
    heroNextStep();
  }
}

function heroNextStep(){
  var idx=heroSteps.indexOf(heroStep);
  if(idx<heroSteps.length-1){heroStep=heroSteps[idx+1];renderHeroStep()}
}

function heroPrevStep(){
  var idx=heroSteps.indexOf(heroStep);
  if(idx>0){
    var prev=heroSteps[idx-1];
    if(prev==='category'){activeCategory='';activeCategories=[];renderCategoryBoxes()}
    if(prev==='color'){activeColor='';activeColors=[];renderColorGrid()}
    if(prev==='price'){var sl=document.getElementById("priceRange");sl.value=sl.max;document.getElementById("priceValue").textContent=sl.max}
    if(prev==='size'){activeSize='';activeSizes=[];renderSizeBoxes()}
    if(prev==='style'){activeStyle='';activeStyles=[];renderStyleBoxes()}
    if(prev==='fit'){activeFit='';activeFits=[];renderFitBoxes()}
    if(prev==='fabric'){activeFabric='';activeFabrics=[];renderFabricBoxes()}
    updateActiveFiltersBar();
    runRegularSearch();
    heroStep=prev;
    renderHeroStep();
  }
}

function checkHideHero(){
  var hero=document.getElementById('heroDiscover');
  if(hero&&!hero.classList.contains('hidden'))hero.classList.add('hidden');
}

var _origSelectStore=selectStore;
selectStore=function(s){checkHideHero();_origSelectStore(s)};
var _origRunAI=runAISearch;
runAISearch=async function(){checkHideHero();await _origRunAI()};

(async function(){await initFilters();renderHeroStep();skipScrollOnSearch=true;await runRegularSearch();window.scrollTo(0,0)})();
</script>

  <!-- AUTH MODAL -->
  <div class="auth-modal-bg" id="authModalBg" onclick="closeAuthIfBg(event)">
    <div class="auth-modal" onclick="event.stopPropagation()" style="position:relative">
      <button class="auth-modal-close" onclick="closeAuthModal()">✕</button>
      <div class="auth-modal-head">
        <h2 id="authModalTitle">ברוכה הבאה ל-LOOKLI</h2>
        <p id="authModalSub">שמרי מוצרים אהובים וגשי אליהם בכל זמן</p>
      </div>
      <div class="auth-modal-body">
        <div class="auth-tabs" id="authTabsRow">
          <button class="auth-tab active" onclick="switchAuthTab('login')">התחברות</button>
          <button class="auth-tab" onclick="switchAuthTab('register')">הרשמה</button>
        </div>
        <div class="auth-error" id="authError"></div>
        <div class="auth-success" id="authSuccess"></div>
        <!-- Login form -->
        <div id="loginForm">
          <div class="auth-field">
            <label>אימייל</label>
            <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email"/>
          </div>
          <div class="auth-field">
            <label>סיסמה</label>
            <input type="password" id="loginPass" placeholder="••••••" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"/>
          </div>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#6b7280;cursor:pointer;margin-bottom:16px;user-select:none">
            <input type="checkbox" id="rememberMe" checked style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer"/>
            זכור אותי
          </label>
          <button class="auth-submit" id="loginBtn" onclick="doLogin()">התחברות</button>
        </div>
        <!-- Register form -->
        <div id="registerForm" style="display:none">
          <div class="auth-field">
            <label>שם (אופציונלי)</label>
            <input type="text" id="regName" placeholder="השם שלך"/>
          </div>
          <div class="auth-field">
            <label>אימייל</label>
            <input type="email" id="regEmail" placeholder="your@email.com" autocomplete="email"/>
          </div>
          <div class="auth-field">
            <label>סיסמה (לפחות 6 תווים)</label>
            <input type="password" id="regPass" placeholder="••••••" autocomplete="new-password" onkeydown="if(event.key==='Enter')doRegister()"/>
          </div>
          <button class="auth-submit" id="registerBtn" onclick="doRegister()">יצירת חשבון</button>
        </div>
        <!-- Profile (when logged in) -->
        <div id="profileForm" style="display:none">
          <div style="text-align:center;margin-bottom:20px">
            <div style="width:64px;height:64px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-size:28px;font-weight:800;margin:0 auto 12px" id="profileAvatar">?</div>
            <div style="font-weight:700;font-size:16px" id="profileName">-</div>
            <div style="color:#9ca3af;font-size:13px;margin-top:4px" id="profileEmail">-</div>
            <div style="margin-top:8px" id="profilePlanBadge"></div>
          </div>
          <button class="auth-submit" onclick="openSavedPanel();closeAuthModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;vertical-align:middle;margin-left:6px"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            המוצרים השמורים שלי
          </button>
          <button class="auth-logout-btn" onclick="doLogout()">יציאה מהחשבון</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SAVED PRODUCTS PANEL -->
  <div class="saved-panel-bg" id="savedPanelBg" onclick="closeSavedIfBg(event)">
    <div class="saved-panel" onclick="event.stopPropagation()">
      <div class="saved-panel-head">
        <h3>המוצרים השמורים שלי <span class="saved-count" id="savedPanelCount">0</span></h3>
        <button class="saved-panel-close" onclick="closeSavedPanel()">✕</button>
      </div>
      <div class="user-profile-bar" id="savedProfileBar"></div>
      <div class="saved-panel-body" id="savedPanelBody">
        <div class="saved-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          <div>עדיין אין מוצרים שמורים</div>
          <div style="font-size:12px;margin-top:6px">לחצי על הלב על מוצר כדי לשמור אותו</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ===== AUTH STATE =====
  let currentUser = null;
  let savedUrls = new Set();
  let authToken = localStorage.getItem('lookli_token') || null;

  // Init on load
  (async function initAuth() {
    if (!authToken) return;
    try {
      const res = await fetch('/api/auth/me', { headers: { Authorization: 'Bearer ' + authToken } });
      if (!res.ok) { authToken = null; localStorage.removeItem('lookli_token'); return; }
      const data = await res.json();
      setUser(data.user);
    } catch(e) {}
  })();

  function setUser(user) {
    currentUser = user;
    const label = document.getElementById('authNavLabel');
    const savedBtn = document.getElementById('savedNavBtn');
    const authBtn = document.getElementById('authNavBtn');
    if (user) {
      label.textContent = user.name || user.email.split('@')[0];
      if (savedBtn) savedBtn.style.display = 'flex';
    } else {
      label.textContent = 'התחברות';
      if (savedBtn) savedBtn.style.display = 'none';
    }
    refreshSavedState();
  }

  async function refreshSavedState() {
    if (!currentUser || !authToken) { savedUrls = new Set(); return; }
    try {
      const res = await fetch('/api/saved', { headers: { Authorization: 'Bearer ' + authToken } });
      const data = await res.json();
      savedUrls = new Set(data.saved.map(s => s.product_source_url));
      updateSavedCount();
      // update hearts on visible cards
      document.querySelectorAll('.card-save-btn').forEach(btn => {
        const url = btn.dataset.url;
        btn.classList.toggle('saved', savedUrls.has(url));
      });
    } catch(e) {}
  }

  function updateSavedCount() {
    const el = document.getElementById('savedNavCount');
    if (el) el.textContent = savedUrls.size > 0 ? savedUrls.size : '';
  }

  // ===== AUTH MODAL =====
  function openAuthModal() {
    if (currentUser) {
      // Show profile
      switchAuthTab('profile');
    } else {
      switchAuthTab('login');
    }
    document.getElementById('authModalBg').classList.add('open');
    clearAuthMessages();
  }

  function closeAuthModal() {
    document.getElementById('authModalBg').classList.remove('open');
  }

  function closeAuthIfBg(e) {
    if (e.target === document.getElementById('authModalBg')) closeAuthModal();
  }

  function switchAuthTab(tab) {
    const loginF = document.getElementById('loginForm');
    const regF = document.getElementById('registerForm');
    const profF = document.getElementById('profileForm');
    const tabs = document.getElementById('authTabsRow');
    loginF.style.display = 'none';
    regF.style.display = 'none';
    profF.style.display = 'none';
    if (tab === 'profile') {
      tabs.style.display = 'none';
      profF.style.display = 'block';
      if (currentUser) {
        const initials = (currentUser.name || currentUser.email)[0].toUpperCase();
        document.getElementById('profileAvatar').textContent = initials;
        document.getElementById('profileName').textContent = currentUser.name || '—';
        document.getElementById('profileEmail').textContent = currentUser.email;
        const badge = document.getElementById('profilePlanBadge');
        badge.innerHTML = currentUser.plan === 'premium' ?
          '<span style="background:#fef3c7;color:#d97706;border-radius:20px;padding:4px 12px;font-size:12px;font-weight:700">⭐ Premium</span>' :
          '<span style="background:#f3f4f6;color:#9ca3af;border-radius:20px;padding:4px 12px;font-size:12px;font-weight:600">חשבון חינמי</span>';
      }
    } else {
      tabs.style.display = 'flex';
      document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register')));
      if (tab === 'login') loginF.style.display = 'block';
      else regF.style.display = 'block';
    }
    clearAuthMessages();
  }

  function clearAuthMessages() {
    const err = document.getElementById('authError');
    const suc = document.getElementById('authSuccess');
    err.classList.remove('show'); suc.classList.remove('show');
  }

  function showAuthError(msg) {
    const el = document.getElementById('authError');
    el.textContent = msg; el.classList.add('show');
  }

  function showAuthSuccess(msg) {
    const el = document.getElementById('authSuccess');
    el.textContent = msg; el.classList.add('show');
  }

  async function doLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    if (!email || !pass) return showAuthError('אימייל וסיסמה חובה');
    const btn = document.getElementById('loginBtn');
    btn.disabled = true; btn.textContent = 'מתחבר...';
    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password: pass })
      });
      const data = await res.json();
      if (!res.ok) { showAuthError(data.error || 'שגיאה'); return; }
      authToken = data.token;
      const remember = document.getElementById('rememberMe');
      if (remember && remember.checked) {
        localStorage.setItem('lookli_token', authToken);
      } else {
        sessionStorage.setItem('lookli_token', authToken);
        localStorage.removeItem('lookli_token');
      }
      setUser(data.user);
      showAuthSuccess('התחברת בהצלחה!');
      setTimeout(closeAuthModal, 900);
    } catch(e) { showAuthError('שגיאת חיבור'); }
    finally { btn.disabled = false; btn.textContent = 'התחברות'; }
  }

  async function doRegister() {
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPass').value;
    if (!email || !pass) return showAuthError('אימייל וסיסמה חובה');
    if (pass.length < 6) return showAuthError('סיסמה חייבת לפחות 6 תווים');
    const btn = document.getElementById('registerBtn');
    btn.disabled = true; btn.textContent = 'יוצר חשבון...';
    try {
      const res = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, password: pass })
      });
      const data = await res.json();
      if (!res.ok) { showAuthError(data.error || 'שגיאה'); return; }
      authToken = data.token;
      localStorage.setItem('lookli_token', authToken);
      setUser(data.user);
      showAuthSuccess('ברוכה הבאה! החשבון נוצר בהצלחה');
      setTimeout(closeAuthModal, 900);
    } catch(e) { showAuthError('שגיאת חיבור'); }
    finally { btn.disabled = false; btn.textContent = 'יצירת חשבון'; }
  }

  function doLogout() {
    authToken = null;
    currentUser = null;
    savedUrls = new Set();
    localStorage.removeItem('lookli_token');
    sessionStorage.removeItem('lookli_token');
    setUser(null);
    closeAuthModal();
    // Remove saved state from all hearts
    document.querySelectorAll('.card-save-btn').forEach(btn => btn.classList.remove('saved'));
  }

  // ===== SAVED PANEL =====
  async function openSavedPanel() {
    if (!currentUser) { openAuthModal(); return; }
    document.getElementById('savedPanelBg').classList.add('open');
    await loadSavedPanel();
  }

  function closeSavedPanel() {
    document.getElementById('savedPanelBg').classList.remove('open');
  }

  function closeSavedIfBg(e) {
    if (e.target === document.getElementById('savedPanelBg')) closeSavedPanel();
  }

  async function loadSavedPanel() {
    if (!authToken) return;
    const body = document.getElementById('savedPanelBody');
    const countEl = document.getElementById('savedPanelCount');
    const profileBar = document.getElementById('savedProfileBar');

    // Profile bar
    if (currentUser) {
      const initials = (currentUser.name || currentUser.email)[0].toUpperCase();
      profileBar.innerHTML = `
        <div class="user-avatar">${initials}</div>
        <div class="user-info">
          <div class="user-email">${currentUser.name || currentUser.email}</div>
          <div class="user-plan ${currentUser.plan}">${currentUser.plan === 'premium' ? '⭐ Premium' : 'חשבון חינמי'}</div>
        </div>`;
    }

    body.innerHTML = '<div style="text-align:center;padding:40px;color:#9ca3af">טוענת...</div>';
    try {
      const res = await fetch('/api/saved', { headers: { Authorization: 'Bearer ' + authToken } });
      const data = await res.json();
      savedUrls = new Set(data.saved.map(s => s.product_source_url));
      updateSavedCount();
      countEl.textContent = data.saved.length;
      if (data.saved.length === 0) {
        body.innerHTML = `<div class="saved-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          <div>עדיין אין מוצרים שמורים</div>
          <div style="font-size:12px;margin-top:6px">לחצי על הלב על מוצר כדי לשמור</div>
        </div>`;
        return;
      }
      body.innerHTML = data.saved.map(s => `
        <div class="saved-item" id="saved-${btoa(s.product_source_url).replace(/[^a-z0-9]/gi,'').slice(0,12)}">
          <img src="${s.product_image || ''}" alt="${s.product_title || ''}" onerror="this.style.background='#f3f4f6'"/>
          <div class="saved-item-info">
            <div class="saved-item-title">${s.product_title || 'מוצר'}</div>
            <div class="saved-item-price">${s.product_price ? '₪' + Number(s.product_price).toFixed(0) : ''}</div>
            <div class="saved-item-store">${s.product_store || ''}</div>
          </div>
          <div class="saved-item-actions">
            <button class="saved-item-remove" title="הסר" onclick="removeSaved('${s.product_source_url.replace(/'/g,"\'")}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/></svg>
            </button>
            <a class="saved-item-buy" href="${s.product_source_url}" target="_blank">לרכישה</a>
          </div>
        </div>`).join('');
    } catch(e) { body.innerHTML = '<div style="text-align:center;padding:40px;color:#ef4444">שגיאה בטעינה</div>'; }
  }

  async function removeSaved(url) {
    if (!authToken) return;
    try {
      await fetch('/api/saved', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + authToken },
        body: JSON.stringify({ source_url: url })
      });
      savedUrls.delete(url);
      updateSavedCount();
      // update heart on card
      document.querySelectorAll('.card-save-btn').forEach(btn => {
        if (btn.dataset.url === url) btn.classList.remove('saved');
      });
      await loadSavedPanel();
    } catch(e) {}
  }

  function handleSaveClick(btn) {
    const url = btn.dataset.url;
    const title = btn.dataset.title;
    const price = parseFloat(btn.dataset.price) || 0;
    const image = btn.dataset.image;
    const store = btn.dataset.store;
    toggleSave(url, title, price, image, store, btn);
  }

  async function toggleSave(url, title, price, image, store, btnEl) {
    if (!currentUser) { openAuthModal(); return; }
    if (savedUrls.has(url)) {
      await removeSaved(url);
      btnEl.classList.remove('saved');
    } else {
      try {
        await fetch('/api/saved', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + authToken },
          body: JSON.stringify({ source_url: url, title, price, image, store })
        });
        savedUrls.add(url);
        updateSavedCount();
        btnEl.classList.add('saved');
      } catch(e) {}
    }
  }
  
  // ===== IMAGE AVAILABILITY FILTER =====
  let filterImgAvail = false;

  function markCardBlocked(imgEl) {
    // Find parent card and mark it
    const card = imgEl.closest('.card');
    if (card) {
      card.dataset.imgBlocked = '1';
      if (filterImgAvail) card.classList.add('img-blocked');
    }
  }

  function toggleImgFilter(enabled) {
    filterImgAvail = enabled;
    document.querySelectorAll('.card').forEach(card => {
      if (card.dataset.imgBlocked === '1') {
        card.classList.toggle('img-blocked', enabled);
      }
    });
    // Update count display
    const visible = document.querySelectorAll('.card:not(.img-blocked)').length;
    if (enabled) {
      document.getElementById('metaToolbar').textContent = visible + ' מוצרים עם תמונה גלויה';
    } else {
      document.getElementById('metaToolbar').textContent = allProducts.length + ' מוצרים';
    }
  }

  // ===== SPONSORED PRODUCTS =====
  async function loadSponsored(query) {
    try {
      const params = new URLSearchParams();
      if (query) params.set('q', query);
      const res = await fetch('/api/sponsored?' + params.toString());
      if (!res.ok) return;
      const data = await res.json();
      const strip = document.getElementById('sponsoredStrip');
      const row = document.getElementById('sponsoredRow');
      if (!data.sponsored || data.sponsored.length === 0) { strip.style.display='none'; return; }
      strip.style.display = 'block';
      row.innerHTML = data.sponsored.map(p => `
        <div class="sponsored-card" onclick="window.open('${p.source_url}','_blank')">
          <span class="sponsored-badge">ממומן</span>
          <img class="sponsored-img" src="${escapeHtml(p.image_url||'')}" alt="${escapeHtml(p.title||'')}" loading="lazy" onerror="this.style.background='#f3f4f6'"/>
          <div class="sponsored-body">
            <div class="sponsored-title">${escapeHtml(p.title||'')}</div>
            <div class="sponsored-price">${p.price ? '₪'+Number(p.price).toFixed(0) : ''}</div>
            <div class="sponsored-store">${escapeHtml(p.store||'')}</div>
          </div>
        </div>`).join('');
    } catch(e) {}
  }

  // ===== SEO: Update URL & title on search =====
  function updateSeoMeta(query) {
    const base = 'LOOKLI – מנוע חיפוש חכם לאופנה צנועה';
    if (query) {
      document.title = query + ' | ' + base;
      history.replaceState(null, '', '/?q=' + encodeURIComponent(query));
    } else {
      document.title = base + ' | אלפי מוצרים במקום אחד';
      history.replaceState(null, '', '/');
    }
  }
</script>

</body>
</html>
